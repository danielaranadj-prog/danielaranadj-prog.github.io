<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Instante Trips V5.0 Final</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Plus Jakarta Sans', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        /* ESTILOS BASE */
        body { 
            background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            transition: background 0.3s;
        }
        
        /* MODO OSCURO */
        body.dark { background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); color: #e2e8f0; }

        /* GLASSMORPHISM */
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 16px;
        }
        .dark .glass-card { background: rgba(30, 41, 59, 0.8); border-color: rgba(255,255,255,0.05); }

        /* INPUTS */
        .input-modern {
            background: rgba(255, 255, 255, 0.6);
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .input-modern:focus { border-color: #f97316; background: #fff; outline: none; }
        .dark .input-modern { background: rgba(15, 23, 42, 0.6); color: white; }
        .dark .input-modern:focus { background: rgba(30, 41, 59, 1); }

        /* SEO INDICATORS */
        .seo-indicator { transition: all 0.3s; width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .seo-good { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .seo-ok { background: #eab308; box-shadow: 0 0 8px #eab308; }
        .seo-bad { background: #ef4444; box-shadow: 0 0 8px #ef4444; }

        /* EDITOR */
        .rich-editor { min-height: 100px; padding: 1rem; outline: none; }
        .rich-editor:empty:before { content: attr(placeholder); color: #94a3b8; pointer-events: none; }

        /* TOOLS */
        .toolbar-btn {
            padding: 6px 10px; border-radius: 8px; font-size: 0.85rem; font-weight: 600;
            background: rgba(255,255,255,0.5); border: 1px solid transparent; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 4px;
        }
        .toolbar-btn:hover { background: #fff; border-color: #f97316; color: #f97316; transform: translateY(-1px); }
        .dark .toolbar-btn { background: rgba(255,255,255,0.1); color: #ccc; }
        .dark .toolbar-btn:hover { background: rgba(249, 115, 22, 0.2); color: #f97316; }

        /* DRAG & DROP */
        .drag-handle { cursor: grab; opacity: 0.3; transition: opacity 0.2s; }
        .group:hover .drag-handle { opacity: 1; }
        .sortable-ghost { opacity: 0.4; background: #fff7ed; border: 2px dashed #f97316; }
        .dark .sortable-ghost { background: #331a0f; }

        /* UTILS */
        .loader { width: 20px; height: 20px; border: 2px solid #f97316; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 50; display: none; place-items: center; }
        .modal-overlay.open { display: grid; }
    </style>
</head>

<body class="antialiased text-slate-800 dark:text-slate-200">

    <div id="load-post-modal" class="modal-overlay">
        <div class="glass-card w-[90%] max-w-2xl p-6 bg-white dark:bg-slate-900 max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-display font-bold text-orange-600">üìÇ Cargar Post</h3>
                <button onclick="closeLoadModal()" class="text-2xl opacity-50 hover:opacity-100">√ó</button>
            </div>
            <input type="text" id="search-posts" placeholder="üîç Buscar por t√≠tulo..." class="w-full p-3 rounded-xl input-modern mb-4" oninput="filterPosts()">
            <div id="posts-list" class="space-y-2 flex-1 overflow-y-auto pr-2">
                <div class="text-center py-10 opacity-50">Cargando...</div>
            </div>
        </div>
    </div>

    <div id="author-modal" class="modal-overlay">
        <div class="glass-card w-[90%] max-w-md p-6 bg-white dark:bg-slate-900">
            <h3 class="text-xl font-bold mb-4">üë§ Nuevo Autor</h3>
            <div class="space-y-3">
                <input type="text" id="new-auth-name" placeholder="Nombre completo" class="w-full p-3 rounded-xl input-modern">
                <input type="text" id="new-auth-role" placeholder="Rol (ej. Editor)" class="w-full p-3 rounded-xl input-modern">
                <textarea id="new-auth-bio" rows="2" placeholder="Bio corta..." class="w-full p-3 rounded-xl input-modern resize-none"></textarea>
                <div class="p-3 border dark:border-slate-700 rounded-xl bg-slate-50 dark:bg-slate-800">
                    <span class="text-xs font-bold block mb-1">Foto de perfil:</span>
                    <input type="file" id="new-auth-file" accept="image/*" class="w-full text-xs">
                </div>
                <div class="flex gap-2 pt-2">
                    <button onclick="closeAuthorModal()" class="flex-1 py-3 rounded-xl font-bold opacity-60 hover:opacity-100 hover:bg-slate-100 dark:hover:bg-slate-800">Cancelar</button>
                    <button onclick="saveNewAuthor()" id="btn-save-auth" class="flex-1 py-3 rounded-xl bg-orange-500 text-white font-bold hover:bg-orange-600 shadow-lg shadow-orange-500/30">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="login-section" class="flex items-center justify-center min-h-screen p-4">
        <div class="glass-card p-10 w-full max-w-[400px] text-center">
            <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-orange-400 to-red-500 rounded-2xl flex items-center justify-center text-4xl shadow-xl shadow-orange-500/20">‚úàÔ∏è</div>
            <h1 class="text-2xl font-display font-bold mb-1">Instante Trips</h1>
            <p class="text-sm opacity-60 mb-8">Editor Pro V5.0</p>
            <form id="login-form" class="space-y-4">
                <input type="email" id="email" placeholder="Email" class="w-full p-4 rounded-xl input-modern" required>
                <input type="password" id="password" placeholder="Contrase√±a" class="w-full p-4 rounded-xl input-modern" required>
                <button type="submit" class="w-full py-4 rounded-xl bg-slate-900 text-white font-bold hover:scale-[1.02] transition">Ingresar</button>
            </form>
            <p id="login-error" class="text-red-500 text-xs mt-4 hidden"></p>
        </div>
    </div>

    <div id="app-section" class="hidden min-h-screen flex flex-col">
        <header class="sticky top-0 z-40 px-4 py-3">
            <div class="glass-card max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-red-600 rounded-lg flex items-center justify-center text-xl shadow-lg shadow-orange-500/20">‚úàÔ∏è</div>
                    <div>
                        <span class="font-display font-bold text-lg leading-tight block">Editor V5</span>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] font-mono opacity-50" id="welcome-msg">Usuario</span>
                            <span id="save-status" class="text-[10px] bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded-full text-slate-500">Guardado</span>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <button onclick="toggleDarkMode()" class="w-10 h-10 rounded-xl hover:bg-black/5 dark:hover:bg-white/10 flex items-center justify-center text-xl" title="Modo Oscuro">üåì</button>
                    
                    <div class="h-6 w-px bg-slate-200 dark:bg-slate-700 mx-1 hidden md:block"></div>
                    
                    <button onclick="openLoadModal()" class="hidden md:flex toolbar-btn" title="Ctrl+L">üìÇ <span class="hidden lg:inline">Cargar</span></button>
                    <button onclick="togglePreviewMode()" class="hidden md:flex toolbar-btn" title="Ver C√≥digo">üëÅÔ∏è <span class="hidden lg:inline">Vista</span></button>
                    <button onclick="downloadMarkdown()" class="hidden md:flex toolbar-btn" title="Backup Local">üíæ <span class="hidden lg:inline">MD</span></button>
                    
                    <button id="btn-logout" class="ml-2 text-xs font-bold text-red-500 hover:bg-red-50 px-3 py-2 rounded-lg transition">Salir</button>
                </div>
            </div>
        </header>

        <main class="flex-1 max-w-7xl mx-auto w-full p-4 grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <div class="flex flex-col gap-6 lg:col-span-7 pb-20">
                
                <div class="glass-card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xs font-bold uppercase tracking-wider text-slate-400">üìù Metadata & SEO</h2>
                        <button onclick="clearAll()" class="text-xs text-red-500 hover:text-red-600 font-bold">üóëÔ∏è Limpiar</button>
                    </div>

                    <div class="space-y-4">
                        <div class="relative">
                            <input type="text" id="post-title" class="w-full p-4 rounded-xl input-modern font-display font-bold text-xl pr-12" placeholder="T√≠tulo del Art√≠culo" oninput="updateSEO(); updatePreview()">
                            <div class="absolute right-4 top-1/2 -translate-y-1/2 flex items-center gap-2">
                                <span id="title-count" class="text-[10px] font-mono opacity-50">0</span>
                                <div id="title-seo" class="seo-indicator bg-slate-300"></div>
                            </div>
                        </div>

                        <div class="relative">
                            <textarea id="post-desc" rows="2" class="w-full p-4 rounded-xl input-modern resize-none text-sm pr-12" placeholder="Meta descripci√≥n para Google..." oninput="updateSEO(); updatePreview()"></textarea>
                            <div class="absolute right-4 bottom-4 flex items-center gap-2">
                                <span id="desc-count" class="text-[10px] font-mono opacity-50">0</span>
                                <div id="desc-seo" class="seo-indicator bg-slate-300"></div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] font-bold uppercase opacity-50 mb-1">Fecha</label>
                                <input type="date" id="post-date" class="w-full p-3 rounded-xl input-modern text-sm" onchange="updatePreview()">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold uppercase opacity-50 mb-1">Autor</label>
                                <div class="flex gap-2">
                                    <select id="post-author" class="flex-1 p-3 rounded-xl input-modern text-sm" onchange="updatePreview()">
                                        <option value="">Cargando...</option>
                                    </select>
                                    <button onclick="openAuthorModal()" class="px-3 rounded-xl bg-slate-100 dark:bg-slate-700 hover:bg-orange-100 text-orange-600 font-bold">+</button>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-[10px] font-bold uppercase opacity-50 mb-1">Hero Image</label>
                            <div class="flex gap-2">
                                <input type="url" id="post-hero" class="flex-1 p-3 rounded-xl input-modern text-sm" placeholder="https://..." oninput="updatePreview()">
                                <label class="cursor-pointer bg-slate-800 text-white px-4 py-3 rounded-xl hover:bg-slate-900 transition flex items-center justify-center">
                                    üì§ <input type="file" class="hidden" accept="image/*" onchange="uploadHeroImage(this)">
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block text-[10px] font-bold uppercase opacity-50 mb-1">Tags</label>
                            <div class="flex gap-2 mb-2">
                                <input type="text" id="tag-input" placeholder="Escribe y presiona Enter" class="flex-1 p-3 rounded-xl input-modern text-sm">
                                <button onclick="addTag()" class="px-4 rounded-xl bg-orange-100 text-orange-600 font-bold">+</button>
                            </div>
                            <div id="tags-container" class="flex flex-wrap gap-2 min-h-[30px]"></div>
                        </div>
                    </div>
                </div>

                <div class="glass-card p-6">
                    <h2 class="text-xs font-bold uppercase tracking-wider text-slate-400 mb-4">Bloques de Contenido</h2>
                    
                    <div class="flex flex-wrap gap-2 mb-6 p-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-800/50">
                        <button onclick="addBlock('h2')" class="toolbar-btn">H2</button>
                        <button onclick="addBlock('h3')" class="toolbar-btn">H3</button>
                        <button onclick="addBlock('p')" class="toolbar-btn">üìÑ Texto</button>
                        <button onclick="addBlock('quote')" class="toolbar-btn">‚ùù Cita</button>
                        <div class="w-px h-6 bg-slate-300 mx-1 self-center"></div>
                        <button onclick="addBlock('img')" class="toolbar-btn">üñºÔ∏è Img</button>
                        <button onclick="addBlock('yt')" class="toolbar-btn">üé¨ YT</button>
                        <button onclick="addBlock('list')" class="toolbar-btn">üìã Lista</button>
                        <button onclick="addBlock('hr')" class="toolbar-btn" title="Separador">‚ûñ</button>
                    </div>

                    <div id="blocks-container" class="space-y-4 min-h-[200px] pb-10">
                        <div class="text-center py-10 opacity-30 italic text-sm border-2 border-dashed rounded-xl">
                            Arrastra y suelta bloques aqu√≠ o usa la barra superior
                        </div>
                    </div>
                </div>

                <div class="glass-card p-4 sticky bottom-4 z-30">
                    <button onclick="publishCurrentPost()" class="w-full py-4 rounded-xl bg-gradient-to-r from-orange-500 to-red-600 text-white font-bold text-lg shadow-xl shadow-orange-500/30 hover:scale-[1.01] transition-transform flex items-center justify-center gap-2">
                        üöÄ Publicar Art√≠culo
                    </button>
                </div>
            </div>

            <div class="hidden lg:flex flex-col gap-6 lg:col-span-5">
                <div class="glass-card sticky top-24 flex flex-col h-[calc(100vh-8rem)] overflow-hidden">
                    <div class="p-4 border-b dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/50">
                        <span class="font-bold text-xs uppercase opacity-70">üì± Vista Previa</span>
                        <span id="word-count" class="text-xs font-mono opacity-50">0 palabras</span>
                    </div>
                    
                    <div id="preview-html" class="flex-1 p-6 overflow-y-auto prose prose-sm dark:prose-invert max-w-none"></div>
                    
                    <div id="preview-md" class="hidden flex-1 p-6 overflow-y-auto bg-slate-900 text-green-400 font-mono text-xs whitespace-pre-wrap"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="toast-container" class="fixed bottom-6 right-6 z-[70] flex flex-col gap-3"></div>

    <script type="module">
        // FIREBASE SETUP
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBdsu65Voj8en9u_7eL5q0YRFuCC7fUYWA",
            authDomain: "instantetrips-editor.firebaseapp.com",
            projectId: "instantetrips-editor",
            storageBucket: "instantetrips-editor.firebasestorage.app",
            messagingSenderId: "281917140804",
            appId: "1:281917140804:web:ed712e65c9c4b77dd3b111"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // ESTADO GLOBAL
        let githubConfig = null;
        let blocks = [];
        let tags = [];
        let allPosts = [];
        let currentPostSha = null;
        let currentPostFilename = null;
        let autosaveInterval = null;

        // --- 1. AUTENTICACI√ìN ---
        const loginForm = document.getElementById('login-form');
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = loginForm.querySelector('button');
            const originalText = btn.innerText;
            btn.innerHTML = '<div class="loader mx-auto"></div>'; btn.disabled = true;
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
            } catch (error) {
                document.getElementById('login-error').classList.remove('hidden');
                document.getElementById('login-error').textContent = '‚ùå ' + error.message;
                btn.innerHTML = originalText; btn.disabled = false;
            }
        });

        window.logout = () => signOut(auth);
        document.getElementById('btn-logout').addEventListener('click', logout);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('app-section').classList.remove('hidden');
                document.getElementById('welcome-msg').textContent = user.email.split('@')[0];
                document.getElementById('post-date').valueAsDate = new Date();

                // Cargar Config
                const docSnap = await getDoc(doc(db, "config", "main"));
                if (docSnap.exists()) {
                    githubConfig = docSnap.data();
                    if (!githubConfig.postsPath.endsWith('/')) githubConfig.postsPath += '/';
                    loadAuthorsFromRepo();
                    startAutosave();
                    checkDraft();
                } else {
                    showToast("‚ö†Ô∏è Falta configuraci√≥n en Firebase", "error");
                }
            } else {
                document.getElementById('login-section').classList.remove('hidden');
                document.getElementById('app-section').classList.add('hidden');
                stopAutosave();
            }
        });

        // --- 2. SISTEMA DE AUTOGUARDADO (NUEVO) ---
        function startAutosave() {
            if(autosaveInterval) clearInterval(autosaveInterval);
            autosaveInterval = setInterval(saveDraftToLocal, 10000); // 10s
        }

        function stopAutosave() {
            if(autosaveInterval) clearInterval(autosaveInterval);
        }

        function saveDraftToLocal() {
            if(blocks.length === 0 && !document.getElementById('post-title').value) return;
            
            const draft = {
                title: document.getElementById('post-title').value,
                desc: document.getElementById('post-desc').value,
                date: document.getElementById('post-date').value,
                author: document.getElementById('post-author').value,
                hero: document.getElementById('post-hero').value,
                tags: tags,
                blocks: blocks,
                filename: currentPostFilename,
                sha: currentPostSha,
                timestamp: new Date().toLocaleTimeString()
            };
            
            localStorage.setItem('instante-draft-v5', JSON.stringify(draft));
            document.getElementById('save-status').textContent = `Guardado: ${draft.timestamp}`;
            document.getElementById('save-status').className = "text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full transition-all";
            setTimeout(() => {
                document.getElementById('save-status').className = "text-[10px] bg-slate-100 dark:bg-slate-700 text-slate-500 px-2 py-0.5 rounded-full transition-all";
            }, 2000);
        }

        function checkDraft() {
            const draft = localStorage.getItem('instante-draft-v5');
            if(draft) {
                if(confirm("üìù Encontr√© un borrador no guardado. ¬øQuieres restaurarlo?")) {
                    const d = JSON.parse(draft);
                    document.getElementById('post-title').value = d.title || '';
                    document.getElementById('post-desc').value = d.desc || '';
                    document.getElementById('post-date').value = d.date || '';
                    document.getElementById('post-hero').value = d.hero || '';
                    // Author se setea despu√©s de cargar autores
                    setTimeout(() => document.getElementById('post-author').value = d.author || '', 1000);
                    tags = d.tags || [];
                    blocks = d.blocks || [];
                    currentPostFilename = d.filename;
                    currentPostSha = d.sha;
                    
                    renderTags();
                    renderBlocks();
                    updateSEO();
                    updatePreview();
                    showToast("‚úÖ Borrador restaurado");
                } else {
                    localStorage.removeItem('instante-draft-v5');
                }
            }
        }

        // --- 3. LOGICA SEO Y UI (NUEVO) ---
        window.toggleDarkMode = () => {
            document.body.classList.toggle('dark');
            localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
        };
        // Init Theme
        if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark');

        window.updateSEO = () => {
            const titleLen = document.getElementById('post-title').value.length;
            const descLen = document.getElementById('post-desc').value.length;
            
            // Title logic (50-60 optimal)
            const tEl = document.getElementById('title-seo');
            document.getElementById('title-count').textContent = titleLen;
            tEl.className = 'seo-indicator ' + (titleLen >= 50 && titleLen <= 65 ? 'seo-good' : titleLen > 10 ? 'seo-ok' : 'seo-bad');

            // Desc logic (150-160 optimal)
            const dEl = document.getElementById('desc-seo');
            document.getElementById('desc-count').textContent = descLen;
            dEl.className = 'seo-indicator ' + (descLen >= 140 && descLen <= 165 ? 'seo-good' : descLen > 50 ? 'seo-ok' : 'seo-bad');
        };

        // --- 4. FUNCIONES GITHUB ---
        async function ghFetch(ep, m='GET', b=null) {
            const response = await fetch(`https://api.github.com/repos/${githubConfig.repoOwner}/${githubConfig.repoName}${ep}`, {
                method: m,
                headers: { 'Authorization': `token ${githubConfig.githubToken}`, 'Content-Type': 'application/json' },
                body: b ? JSON.stringify(b) : null
            });
            if (!response.ok) throw new Error(`GitHub error: ${response.status}`);
            return response.json();
        }

        const toBase64 = file => new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
        });

        // --- 5. LOGICA DE BLOQUES COMPLETA ---
        window.addBlock = (type) => {
            // Eliminar placeholder si existe
            const container = document.getElementById('blocks-container');
            if(container.querySelector('.border-dashed')) container.innerHTML = '';
            
            blocks.push({ id: Date.now().toString(), type: type, content: '', credits: '', listType: 'ul' });
            renderBlocks();
            updatePreview();
        };

        window.removeBlock = (id) => {
            if(!confirm("¬øBorrar bloque?")) return;
            blocks = blocks.filter(b => b.id !== id);
            renderBlocks();
            updatePreview();
        };

        window.updateBlockContent = (id, val, extra = null) => {
            const b = blocks.find(b => b.id === id);
            if(b) {
                if(extra === 'credits') b.credits = val;
                else if(extra === 'listType') b.listType = val;
                else b.content = val;
            }
            // Debounce preview update
            updatePreview();
        };

        window.execCmd = (cmd, value = null) => {
            document.execCommand(cmd, false, value);
            updatePreview();
        };

        window.applyLink = () => {
            let url = prompt("URL del enlace:");
            if (url) {
                if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
                document.execCommand('createLink', false, url);
                const sel = window.getSelection();
                if(sel.anchorNode && sel.anchorNode.parentElement.tagName === 'A') {
                    sel.anchorNode.parentElement.target = "_blank";
                }
                updatePreview();
            }
        };

        function renderBlocks() {
            const container = document.getElementById('blocks-container');
            const scrollPos = container.scrollTop;
            container.innerHTML = '';

            if(blocks.length === 0) {
                 container.innerHTML = `<div class="text-center py-10 opacity-30 italic text-sm border-2 border-dashed rounded-xl">Arrastra y suelta bloques aqu√≠ o usa la barra superior</div>`;
                 return;
            }

            blocks.forEach((b) => {
                const el = document.createElement('div');
                el.className = 'glass-card p-4 relative group transition-all hover:border-orange-300 border border-transparent bg-white dark:bg-slate-800';
                el.dataset.id = b.id;

                let dragHandle = `<div class="drag-handle absolute left-2 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-40 hover:!opacity-100 cursor-grab p-2 text-xl">‚ãÆ‚ãÆ</div>`;
                let contentHtml = `<div class="pl-8 pr-2 w-full">`;

                // SWITCH DE TIPOS DE BLOQUE
                if (b.type === 'p' || b.type === 'quote') {
                    contentHtml += `
                        <div class="flex flex-wrap gap-1 p-1 rounded-lg mb-2 border border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 items-center">
                            <button onclick="execCmd('bold')" class="toolbar-btn font-bold">B</button>
                            <button onclick="execCmd('italic')" class="toolbar-btn italic">I</button>
                            <button onclick="execCmd('underline')" class="toolbar-btn underline">U</button>
                            <div class="w-px h-4 bg-slate-300 mx-1"></div>
                            <button onclick="execCmd('justifyLeft')" class="toolbar-btn">‚¨Ö</button>
                            <button onclick="execCmd('justifyCenter')" class="toolbar-btn">‚¨å</button>
                            <button onclick="execCmd('justifyRight')" class="toolbar-btn">‚û°</button>
                            <div class="w-px h-4 bg-slate-300 mx-1"></div>
                            <button onclick="applyLink()" class="toolbar-btn text-blue-500">üîó</button>
                            <button onclick="execCmd('removeFormat')" class="toolbar-btn text-red-400">üßπ</button>
                        </div>
                        <div class="relative">
                            ${b.type === 'quote' ? '<div class="absolute left-0 top-0 bottom-0 w-1 bg-orange-400 rounded-full"></div>' : ''}
                            <div contenteditable="true" class="rich-editor ${b.type==='quote'?'pl-4 italic text-slate-600 dark:text-slate-300':''}" placeholder="${b.type==='quote'?'Escribe la cita...':'Escribe tu p√°rrafo...'}" oninput="updateBlockContent('${b.id}', this.innerHTML)">${b.content}</div>
                        </div>
                    `;
                } else if (b.type === 'img' || b.type === 'yt') {
                    contentHtml += `
                        <div class="space-y-3">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[10px] uppercase font-bold text-orange-500 tracking-wider bg-orange-50 px-2 py-1 rounded">${b.type === 'img' ? 'üñºÔ∏è Imagen' : 'üé¨ Video'}</span>
                            </div>
                            <div class="flex gap-2">
                                <input type="text" class="flex-1 p-2 rounded-lg input-modern text-xs" placeholder="URL..." value="${b.content}" oninput="updateBlockContent('${b.id}', this.value)">
                                ${b.type === 'img' ? `<label class="cursor-pointer bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 px-3 py-2 rounded-lg text-xs font-bold">üì§<input type="file" class="hidden" accept="image/*" onchange="uploadImageToRepo('${b.id}', this)"></label>` : ''}
                            </div>
                            <input type="text" class="w-full p-2 rounded-lg input-modern text-xs italic" placeholder="¬© Cr√©ditos / Pie de foto..." value="${b.credits}" oninput="updateBlockContent('${b.id}', this.value, 'credits')">
                            ${b.type === 'img' && b.content ? `<div class="mt-2"><img src="${b.content.split('|')[0].trim()}" class="h-24 rounded-lg object-cover border"></div>` : ''}
                        </div>
                    `;
                } else if (b.type === 'list') {
                    contentHtml += `
                        <select class="p-1 mb-2 text-xs rounded border dark:border-slate-700 bg-transparent" onchange="updateBlockContent('${b.id}', this.value, 'listType'); renderBlocks();">
                            <option value="ul" ${b.listType==='ul'?'selected':''}>‚Ä¢ Vi√±etas</option>
                            <option value="ol" ${b.listType==='ol'?'selected':''}>1. Numerada</option>
                        </select>
                        <div contenteditable="true" class="rich-editor text-sm min-h-[60px]" placeholder="<li>Item 1</li>" oninput="updateBlockContent('${b.id}', this.innerHTML)">${b.content || '<li>Item</li>'}</div>
                    `;
                } else if (b.type === 'hr') {
                     contentHtml += `<div class="flex items-center justify-center py-4"><div class="h-px w-full bg-slate-200 dark:bg-slate-700"></div><span class="absolute bg-white dark:bg-slate-800 px-2 text-xs text-slate-400">Separador</span></div>`;
                } else {
                    // Headings
                    contentHtml += `
                        <div class="mb-1 text-[10px] font-bold text-slate-400 uppercase">${b.type}</div>
                        <input type="text" class="w-full p-2 rounded-xl input-modern font-display font-bold ${b.type === 'h2' ? 'text-xl' : 'text-lg text-orange-600'}" value="${b.content}" placeholder="Escribe el t√≠tulo..." oninput="updateBlockContent('${b.id}', this.value)">
                    `;
                }

                contentHtml += `</div>`; // Close content wrapper
                
                // Delete Button
                let delBtn = `<button onclick="removeBlock('${b.id}')" class="absolute right-2 top-2 w-6 h-6 flex items-center justify-center rounded-full bg-red-50 text-red-500 opacity-0 group-hover:opacity-100 hover:bg-red-500 hover:text-white transition z-10" title="Eliminar">√ó</button>`;

                el.innerHTML = dragHandle + contentHtml + delBtn;
                container.appendChild(el);
            });
            container.scrollTop = scrollPos;
        }

        // --- 6. PARSER Y GENERADOR MARKDOWN ---
        function generateMarkdown() {
            const title = document.getElementById('post-title').value;
            const desc = document.getElementById('post-desc').value;
            const date = document.getElementById('post-date').value;
            const author = document.getElementById('post-author').value;
            const hero = document.getElementById('post-hero').value;

            let md = `---\ntitle: "${title}"\ndescription: "${desc}"\npublishDate: "${date}"\nauthor: "${author}"\nheroImage: "${hero}"\nlayout: "../../layouts/BlogPost.astro"\ntags: [${tags.map(t => `"${t}"`).join(', ')}]\n---\n\n`;

            blocks.forEach(b => {
                if (b.type === 'h2') md += `## ${b.content}\n\n`;
                else if (b.type === 'h3') md += `### ${b.content}\n\n`;
                else if (b.type === 'p') md += `${b.content}\n\n`;
                else if (b.type === 'quote') md += `> ${b.content}\n\n`;
                else if (b.type === 'hr') md += `***\n\n`;
                else if (b.type === 'img') {
                    const [url, alt] = b.content.split('|').map(s => s.trim());
                    if (url) {
                        md += `![${alt || 'Imagen'}](${url})\n`;
                        if (b.credits) md += `<small class="credit-style">Cr√©ditos: <i>${b.credits}</i></small>\n\n`;
                        else md += '\n';
                    }
                } else if (b.type === 'yt') {
                    if (b.content) {
                        let embedUrl = b.content;
                        if (b.content.includes('watch?v=')) embedUrl = b.content.replace('watch?v=', 'embed/');
                        else if (b.content.includes('youtu.be/')) embedUrl = b.content.replace('youtu.be/', 'youtube.com/embed/');
                        md += `<iframe width="100%" height="400" src="${embedUrl}" frameborder="0" allowfullscreen class="rounded-lg shadow-md"></iframe>\n`;
                        if (b.credits) md += `<small class="credit-style">Fuente: <i>${b.credits}</i></small>\n\n`;
                        else md += '\n';
                    }
                } else if (b.type === 'list') {
                    const tag = b.listType === 'ul' ? 'ul' : 'ol';
                    md += `<${tag}>\n${b.content}\n</${tag}>\n\n`;
                }
            });
            return md;
        }

        function parseMarkdownToEditor(markdown) {
            // ... (Frontmatter parsing igual que antes) ...
            const frontmatterMatch = markdown.match(/^---\n([\s\S]+?)\n---/);
            if (frontmatterMatch) {
                const frontmatter = frontmatterMatch[1];
                const getVal = (key) => { const m = frontmatter.match(new RegExp(`${key}:\\s*["'](.+?)["']`)); return m ? m[1] : ''; };
                
                document.getElementById('post-title').value = getVal('title');
                document.getElementById('post-desc').value = getVal('description');
                document.getElementById('post-date').value = getVal('publishDate');
                document.getElementById('post-author').value = getVal('author');
                document.getElementById('post-hero').value = getVal('heroImage');
                
                const tagsMatch = frontmatter.match(/tags:\s*\[(.*?)\]/);
                if (tagsMatch) tags = tagsMatch[1].split(',').map(t => t.trim().replace(/["']/g, '')).filter(Boolean);
                renderTags();
                updateSEO();
            }

            const contentStart = markdown.indexOf('---', 3) + 4;
            const content = markdown.slice(contentStart).trim();
            blocks = [];
            const lines = content.split('\n');
            let i = 0;
            
            while (i < lines.length) {
                const line = lines[i].trim();
                if(!line) { i++; continue; }

                if (line.startsWith('## ')) {
                    blocks.push({ id: Date.now()+i, type: 'h2', content: line.slice(3) }); i++;
                } else if (line.startsWith('### ')) {
                    blocks.push({ id: Date.now()+i, type: 'h3', content: line.slice(4) }); i++;
                } else if (line.startsWith('> ')) {
                    blocks.push({ id: Date.now()+i, type: 'quote', content: line.slice(2) }); i++;
                } else if (line === '***' || line === '---') {
                    blocks.push({ id: Date.now()+i, type: 'hr' }); i++;
                } else if (line.startsWith('![')) {
                    // Parsing img logic
                    const imgMatch = line.match(/!\[([^\]]*)\]\(([^)]+)\)/);
                    if (imgMatch) {
                        let credits = '';
                        if (i + 1 < lines.length && lines[i + 1].includes('credit-style')) {
                            const creditMatch = lines[i + 1].match(/<i>(.+?)<\/i>/);
                            if (creditMatch) credits = creditMatch[1];
                            i++;
                        }
                        blocks.push({ id: Date.now()+i, type: 'img', content: `${imgMatch[2]} | ${imgMatch[1]}`, credits: credits });
                    }
                    i++;
                } else if (line.startsWith('<iframe')) {
                    // Parsing YT logic
                    const srcMatch = line.match(/src="([^"]+)"/);
                    if (srcMatch) {
                        let credits = '';
                        if (i + 1 < lines.length && lines[i + 1].includes('credit-style')) {
                             const creditMatch = lines[i + 1].match(/<i>(.+?)<\/i>/);
                             if (creditMatch) credits = creditMatch[1];
                             i++;
                        }
                        blocks.push({ id: Date.now()+i, type: 'yt', content: srcMatch[1], credits: credits });
                    }
                    i++;
                } else if (line.startsWith('<ul') || line.startsWith('<ol')) {
                    // List logic
                    const type = line.startsWith('<ul') ? 'ul' : 'ol';
                    let listContent = ''; i++;
                    while(i < lines.length && !lines[i].includes('</'+type+'>')) { listContent += lines[i] + '\n'; i++; }
                    blocks.push({ id: Date.now()+i, type: 'list', content: listContent.trim(), listType: type });
                    i++;
                } else if (!line.startsWith('<small')) {
                    // Paragraph logic
                    let p = line; i++;
                    while(i < lines.length && lines[i].trim() && !lines[i].startsWith('#') && !lines[i].startsWith('!') && !lines[i].startsWith('<') && !lines[i].startsWith('>')) {
                        p += '\n' + lines[i]; i++;
                    }
                    blocks.push({ id: Date.now()+i, type: 'p', content: p.trim() });
                } else {
                    i++;
                }
            }
            renderBlocks();
            updatePreview();
        }

        // --- 7. UTILS Y EVENTOS ---
        // Marked Config
        const renderer = new marked.Renderer();
        const linkRenderer = renderer.link;
        renderer.link = (href, title, text) => {
            const html = linkRenderer.call(renderer, href, title, text);
            return html.replace(/^<a /, '<a target="_blank" rel="noopener noreferrer" ');
        };
        marked.use({ renderer });

        window.updatePreview = () => {
            clearTimeout(window.previewTimeout);
            window.previewTimeout = setTimeout(() => {
                const md = generateMarkdown();
                document.getElementById('preview-md').textContent = md;
                const cleanContent = md.replace(/^---[\s\S]*?---\s*/, '');
                document.getElementById('preview-html').innerHTML = marked.parse(cleanContent);
                const wordCount = cleanContent.split(/\s+/).filter(w => w.length > 0).length;
                document.getElementById('word-count').textContent = `${wordCount} palabras`;
            }, 300);
        };

        window.togglePreviewMode = () => {
            document.getElementById('preview-md').classList.toggle('hidden');
            document.getElementById('preview-html').classList.toggle('hidden');
        };

        window.clearAll = () => {
            if(confirm("¬øEst√°s seguro? Se borrar√° todo.")) {
                blocks = []; tags = [];
                document.getElementById('post-title').value = '';
                document.getElementById('post-desc').value = '';
                document.getElementById('post-hero').value = '';
                localStorage.removeItem('instante-draft-v5');
                renderBlocks(); renderTags(); updateSEO(); updatePreview();
            }
        }
        
        // Tags
        window.addTag = () => {
            const val = document.getElementById('tag-input').value.trim();
            if(val && !tags.includes(val)) { tags.push(val); document.getElementById('tag-input').value = ''; renderTags(); updatePreview(); }
        }
        window.removeTag = (t) => { tags = tags.filter(x => x !== t); renderTags(); updatePreview(); }
        document.getElementById('tag-input').addEventListener('keydown', (e) => { if(e.key === 'Enter') { e.preventDefault(); addTag(); }});
        
        function renderTags() {
            document.getElementById('tags-container').innerHTML = tags.map(t => 
                `<span class="bg-orange-100 text-orange-600 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-2">#${t} <button onclick="removeTag('${t}')" class="hover:text-red-500">√ó</button></span>`
            ).join('');
        }

        // --- 8. SUBIDAS Y AUTORES ---
        window.openAuthorModal = () => document.getElementById('author-modal').classList.add('open');
        window.closeAuthorModal = () => document.getElementById('author-modal').classList.remove('open');
        
        async function loadAuthorsFromRepo() {
            try {
                const file = await ghFetch(`/contents/src/data/authors.ts`);
                const content = decodeURIComponent(escape(atob(file.content)));
                const regex = /slug:\s*['"]([^'"]+)['"][\s\S]*?name:\s*['"]([^'"]+)['"]/g;
                let match;
                const select = document.getElementById('post-author');
                select.innerHTML = '<option value="">Selecciona...</option>';
                while ((match = regex.exec(content)) !== null) {
                    const option = document.createElement('option');
                    option.value = match[1]; option.text = match[2];
                    select.appendChild(option);
                }
            } catch(e) { console.error(e); }
        }

        window.saveNewAuthor = async () => { /* ... L√≥gica anterior sin cambios mayores ... */ 
             // (He mantenido la l√≥gica anterior, asumiendo que ya funcionaba)
             const name = document.getElementById('new-auth-name').value.trim();
             const role = document.getElementById('new-auth-role').value.trim();
             const bio = document.getElementById('new-auth-bio').value.trim();
             const fileInput = document.getElementById('new-auth-file');
             if(!name || !fileInput.files[0]) { showToast("‚ö†Ô∏è Faltan datos", "error"); return; }

             document.getElementById('btn-save-auth').textContent = "Guardando...";
             try {
                const slug = name.toLowerCase().replace(/[^a-z0-9]/g, '-');
                const file = fileInput.files[0];
                const b64 = await toBase64(await imageCompression(file, { maxSizeMB: 0.5 }));
                const cleanFileName = `${slug}.jpg`;
                
                // Upload Image
                await ghFetch(`/contents/public/assets/autores/${cleanFileName}`, 'PUT', { message: `Add author img`, content: b64.split(',')[1], branch: githubConfig.branch });
                
                // Update TS
                const tsFile = await ghFetch(`/contents/src/data/authors.ts`);
                let content = decodeURIComponent(escape(atob(tsFile.content)));
                const newAuthStr = `\n  '${slug}': {\n    slug: '${slug}',\n    name: '${name}',\n    role: '${role}',\n    bio: '${bio}',\n    image: '/assets/autores/${cleanFileName}',\n  },`;
                const insertIndex = content.lastIndexOf('}');
                
                await ghFetch(`/contents/src/data/authors.ts`, 'PUT', {
                    message: `Add author: ${name}`,
                    content: btoa(unescape(encodeURIComponent(content.slice(0, insertIndex) + newAuthStr + content.slice(insertIndex)))),
                    sha: tsFile.sha,
                    branch: githubConfig.branch
                });
                
                closeAuthorModal(); loadAuthorsFromRepo(); showToast("‚úÖ Autor creado");
             } catch(e) { showToast("‚ùå Error al crear autor", "error"); }
             document.getElementById('btn-save-auth').textContent = "Guardar";
        };

        window.uploadHeroImage = async (input) => {
            const file = input.files[0];
            if(!file) return;
            document.getElementById('post-hero').value = "‚åõ Subiendo...";
            try {
                const b64 = await toBase64(await imageCompression(file, { maxSizeMB: 1, maxWidthOrHeight: 1920 }));
                const fname = `${Date.now()}-hero-${file.name.replace(/[^a-z0-9.]/gi, '-').toLowerCase()}`;
                await ghFetch(`/contents/public/uploads/${fname}`, 'PUT', { message: `Upload hero`, content: b64.split(',')[1], branch: githubConfig.branch });
                document.getElementById('post-hero').value = `/uploads/${fname}`;
                updatePreview();
            } catch(e) { showToast("‚ùå Error subiendo imagen", "error"); }
        }

        window.uploadImageToRepo = async (id, input) => {
            const file = input.files[0];
            if(!file) return;
            try {
                const b64 = await toBase64(await imageCompression(file, { maxSizeMB: 1 }));
                const fname = `${Date.now()}-${file.name.replace(/[^a-z0-9.]/gi, '-').toLowerCase()}`;
                await ghFetch(`/contents/public/uploads/${fname}`, 'PUT', { message: `Upload img`, content: b64.split(',')[1], branch: githubConfig.branch });
                updateBlockContent(id, `/uploads/${fname} | ${file.name}`);
                renderBlocks();
            } catch(e) { showToast("‚ùå Error subiendo imagen", "error"); }
        }

        // --- 9. PUBLICAR Y CARGAR ---
        window.openLoadModal = async () => {
             document.getElementById('load-post-modal').classList.add('open');
             const list = document.getElementById('posts-list');
             if(!allPosts.length) {
                 try {
                     const files = await ghFetch(`/contents/${githubConfig.postsPath}`);
                     const mdFiles = files.filter(f => f.name.endsWith('.md'));
                     allPosts = mdFiles.map(f => ({ name: f.name, sha: f.sha }));
                     renderPostsList(allPosts);
                 } catch(e) { list.innerHTML = "Error cargando posts"; }
             }
        }
        window.closeLoadModal = () => document.getElementById('load-post-modal').classList.remove('open');
        
        function renderPostsList(posts) {
            document.getElementById('posts-list').innerHTML = posts.map(p => 
                `<div onclick="loadPostToEditor('${p.name}')" class="p-3 border rounded-xl hover:bg-orange-50 cursor-pointer flex justify-between items-center group">
                    <span class="font-bold text-sm">${p.name}</span>
                    <span class="text-xs text-orange-500 opacity-0 group-hover:opacity-100">Cargar ‚Üí</span>
                </div>`
            ).join('');
        }
        window.filterPosts = () => {
            const term = document.getElementById('search-posts').value.toLowerCase();
            renderPostsList(allPosts.filter(p => p.name.toLowerCase().includes(term)));
        }

        window.loadPostToEditor = async (name) => {
             try {
                 const data = await ghFetch(`/contents/${githubConfig.postsPath}${name}`);
                 const content = decodeURIComponent(escape(atob(data.content)));
                 parseMarkdownToEditor(content);
                 currentPostFilename = name;
                 currentPostSha = data.sha;
                 closeLoadModal();
                 showToast("‚úÖ Post cargado");
             } catch(e) { showToast("Error cargando post", "error"); }
        }

        window.publishCurrentPost = async () => {
            const btn = document.querySelector('button[onclick="publishCurrentPost()"]');
            const original = btn.innerText;
            btn.innerText = "‚åõ Publicando..."; btn.disabled = true;
            
            try {
                const md = generateMarkdown();
                let filename = currentPostFilename;
                if(!filename) {
                     const slug = document.getElementById('post-title').value.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                     const date = document.getElementById('post-date').value;
                     if(!slug || !date) throw new Error("Falta t√≠tulo o fecha");
                     filename = `${date}-${slug}.md`;
                }

                const payload = {
                    message: currentPostFilename ? `Update: ${filename}` : `New: ${filename}`,
                    content: btoa(unescape(encodeURIComponent(md))),
                    branch: githubConfig.branch
                };
                if(currentPostSha) payload.sha = currentPostSha;

                const res = await ghFetch(`/contents/${githubConfig.postsPath}${filename}`, 'PUT', payload);
                currentPostSha = res.content.sha;
                currentPostFilename = filename;
                
                // Limpiar borrador local al publicar con √©xito
                localStorage.removeItem('instante-draft-v5');
                
                showToast("‚úÖ ¬°Post Publicado!");
            } catch(e) {
                console.error(e);
                showToast("‚ùå Error: " + e.message, "error");
            }
            btn.innerText = original; btn.disabled = false;
        }

        // --- 10. DRAG & DROP & UTILS ---
        new Sortable(document.getElementById('blocks-container'), {
            animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost',
            onEnd: (evt) => {
                const item = blocks.splice(evt.oldIndex, 1)[0];
                blocks.splice(evt.newIndex, 0, item);
                updatePreview();
            }
        });

        window.showToast = (msg, type='success') => {
             const t = document.createElement('div');
             t.className = `glass-card px-4 py-3 rounded-xl shadow-xl flex items-center gap-3 border-l-4 ${type==='error'?'border-red-500':'border-green-500'}`;
             t.innerHTML = `<span class="font-bold">${msg}</span>`;
             document.getElementById('toast-container').appendChild(t);
             setTimeout(() => t.remove(), 4000);
        }

        // INIT
        console.log('%c‚úàÔ∏è Editor V5.0 Final Ready', 'color: #f97316; font-size: 20px; font-weight: bold;');
    </script>
</body>
</html>