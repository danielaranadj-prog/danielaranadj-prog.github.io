<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Instantetrips - Editor V5.1</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        slate: { 850: '#1e293b' } // Custom dark
                    }
                }
            }
        }
    </script>

    <style>
        /* BASE & THEME */
        body { background-color: #f3f4f6; color: #111; font-family: 'Inter', sans-serif; transition: background 0.3s; }
        body.dark { background-color: #0f172a; color: #e2e8f0; }

        /* TARJETAS DE BLOQUES (SOLUCI√ìN A "SE VE FEO") */
        .block-card {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.2s;
            position: relative;
            margin-bottom: 1rem;
        }
        .block-card:hover { border-color: #cbd5e1; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .dark .block-card { background: #1e293b; border-color: #334155; }
        .dark .block-card:hover { border-color: #475569; }

        /* EDITOR TEXTO */
        .rich-editor {
            min-height: 80px;
            padding: 1rem;
            outline: none;
            line-height: 1.6;
        }
        .rich-editor:empty:before { content: attr(placeholder); color: #9ca3af; pointer-events: none; }

        /* TOOLBARS */
        .toolbar-inner {
            display: flex;
            gap: 0.25rem;
            padding: 0.5rem;
            border-bottom: 1px solid #f1f5f9;
            background: #f8fafc;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            flex-wrap: wrap;
        }
        .dark .toolbar-inner { background: #0f172a; border-color: #334155; }

        .tool-btn {
            width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #64748b;
            transition: all 0.1s;
        }
        .tool-btn:hover { background: #e2e8f0; color: #0f172a; }
        .dark .tool-btn:hover { background: #334155; color: #fff; }
        
        .tool-sep { width: 1px; height: 16px; background: #e2e8f0; margin: 0 4px; align-self: center; }
        .dark .tool-sep { background: #334155; }

        /* UTILS */
        .loader { width: 20px; height: 20px; border: 2px solid #ccc; border-top-color: #f97316; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 50; display: none; place-items: center; }
        .modal-overlay.open { display: grid; }
        
        /* SEO DOTS */
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .dot-green { background: #22c55e; box-shadow: 0 0 5px #22c55e; }
        .dot-yellow { background: #eab308; }
        .dot-red { background: #ef4444; }
    </style>
</head>

<body class="antialiased">

    <svg style="display: none;">
        <symbol id="icon-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></symbol>
        <symbol id="icon-bold" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M6 4h8a4 4 0 014 4 4 4 0 01-4 4H6z"/><path d="M6 12h9a4 4 0 014 4 4 4 0 01-4 4H6z"/></symbol>
        <symbol id="icon-italic" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="4" x2="10" y2="4"/><line x1="14" y1="20" x2="5" y2="20"/><line x1="15" y1="4" x2="9" y2="20"/></symbol>
        <symbol id="icon-underline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 3v7a6 6 0 006 6 6 6 0 006-6V3"/><line x1="4" y1="21" x2="20" y2="21"/></symbol>
        <symbol id="icon-left" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="17" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="17" y1="18" x2="3" y2="18"/></symbol>
        <symbol id="icon-center" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="10" x2="6" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="18" y1="18" x2="6" y2="18"/></symbol>
        <symbol id="icon-right" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="21" y1="10" x2="7" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="21" y1="18" x2="7" y2="18"/></symbol>
        <symbol id="icon-link" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></symbol>
        <symbol id="icon-clean" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></symbol> </svg>

    <div id="load-post-modal" class="modal-overlay">
        <div class="bg-white dark:bg-slate-900 w-full max-w-2xl rounded-xl shadow-2xl p-6 flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-4 border-b dark:border-slate-800 pb-3">
                <h3 class="font-bold text-lg">üìÇ Explorar Publicaciones</h3>
                <button onclick="closeLoadModal()" class="text-2xl opacity-50 hover:opacity-100">√ó</button>
            </div>
            <input type="text" id="search-posts" placeholder="üîç Buscar por t√≠tulo..." class="w-full p-3 bg-gray-50 dark:bg-slate-800 rounded-lg outline-none mb-4" oninput="filterPosts()">
            <div id="posts-list" class="space-y-2 overflow-y-auto flex-1 pr-2"></div>
        </div>
    </div>

    <div id="author-modal" class="modal-overlay">
        <div class="bg-white dark:bg-slate-900 w-full max-w-lg rounded-xl shadow-2xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">üë• Gesti√≥n de Autores</h3>
                <button onclick="closeAuthorModal()" class="text-2xl">√ó</button>
            </div>
            
            <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-lg mb-6">
                <p class="text-xs font-bold uppercase text-gray-400 mb-2">Crear Nuevo</p>
                <div class="space-y-3">
                    <input type="text" id="new-auth-name" placeholder="Nombre" class="w-full p-2 rounded border border-gray-200 dark:border-slate-600 bg-transparent">
                    <input type="text" id="new-auth-role" placeholder="Rol" class="w-full p-2 rounded border border-gray-200 dark:border-slate-600 bg-transparent">
                    <textarea id="new-auth-bio" rows="2" placeholder="Bio..." class="w-full p-2 rounded border border-gray-200 dark:border-slate-600 bg-transparent resize-none"></textarea>
                    <input type="file" id="new-auth-file" accept="image/*" class="w-full text-xs">
                    <button onclick="saveNewAuthor()" id="btn-save-auth" class="w-full bg-black dark:bg-white text-white dark:text-black font-bold py-2 rounded-lg hover:opacity-90">Guardar Autor</button>
                </div>
            </div>

            <div id="authors-list-container"></div>
        </div>
    </div>

    <div id="login-section" class="flex items-center justify-center min-h-screen p-4 bg-white dark:bg-black">
        <div class="w-full max-w-sm text-center">
            <img src="public/blog.svg" alt="Logo" class="h-12 mx-auto mb-6">
            <h1 class="text-2xl font-bold mb-2">Acceso de autor</h1>
            <p class="text-sm text-gray-500 mb-8">Gesti√≥n de Contenido Instante Trips</p>
            <form id="login-form" class="space-y-4">
                <input type="email" id="email" placeholder="Email" class="w-full p-4 bg-gray-50 dark:bg-slate-900 rounded-xl outline-none border border-transparent focus:border-black" required>
                <input type="password" id="password" placeholder="Contrase√±a" class="w-full p-4 bg-gray-50 dark:bg-slate-900 rounded-xl outline-none border border-transparent focus:border-black" required>
                <button type="submit" class="w-full bg-black dark:bg-white text-white dark:text-black font-bold py-4 rounded-xl hover:scale-[1.02] transition">Iniciar Sesi√≥n</button>
            </form>
            <p id="login-error" class="text-red-500 text-sm mt-4 hidden"></p>
        </div>
    </div>

    <div id="app-section" class="hidden min-h-screen flex flex-col">
        
        <header class="bg-white dark:bg-slate-900 border-b border-gray-200 dark:border-slate-800 sticky top-0 z-40">
            <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <img src="public/blog.svg" alt="Logo" class="h-8">
                    <div class="hidden md:block w-px h-6 bg-gray-300"></div>
                    <div>
                        <h1 class="font-bold text-sm leading-tight">Contenido Instante Trips</h1>
                        <p class="text-[10px] text-gray-500" id="save-status"></p>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <button onclick="toggleDarkMode()" class="p-2 rounded hover:bg-gray-100 dark:hover:bg-slate-800" title="Modo Oscuro">üåì</button>
                    <div class="w-px h-6 bg-gray-300 mx-1"></div>
                    <button onclick="openLoadModal()" class="flex items-center gap-2 px-3 py-2 text-sm font-medium hover:bg-gray-100 dark:hover:bg-slate-800 rounded">üìÇ <span class="hidden sm:inline">Explorar</span></button>
                    <button onclick="downloadMarkdown()" class="flex items-center gap-2 px-3 py-2 text-sm font-medium hover:bg-gray-100 dark:hover:bg-slate-800 rounded">üíæ <span class="hidden sm:inline">MD</span></button>
                    <button id="btn-logout" class="text-sm font-bold text-red-500 px-3 py-2 hover:bg-red-50 rounded">Salir</button>
                </div>
            </div>
        </header>

        <main class="flex-1 max-w-4xl mx-auto w-full p-6 pb-32">
            
            <div class="block-card p-6 mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xs font-bold uppercase text-gray-400">Detalles de la Publicaci√≥n</h2>
                    <button onclick="clearAll()" class="text-xs text-red-400 hover:text-red-600 hover:underline font-bold">üóëÔ∏è Limpiar Todo</button>
                </div>

                <div class="space-y-6">
                    <div class="relative">
                        <input type="text" id="post-title" class="w-full text-2xl font-bold bg-transparent border-b border-gray-200 dark:border-slate-700 py-2 focus:outline-none focus:border-black" placeholder="Escribe el t√≠tulo aqu√≠..." oninput="updateSEO()">
                        <div class="absolute right-0 top-3 flex items-center gap-2">
                            <span id="title-count" class="text-[10px] text-gray-400 font-mono">0</span>
                            <div id="title-seo" class="dot bg-gray-200"></div>
                        </div>
                    </div>

                    <div class="relative">
                        <textarea id="post-desc" rows="2" class="w-full text-sm bg-gray-50 dark:bg-slate-800 p-3 rounded-lg outline-none resize-none" placeholder="Meta descripci√≥n para SEO..." oninput="updateSEO()"></textarea>
                        <div class="absolute right-3 bottom-3 flex items-center gap-2">
                            <span id="desc-count" class="text-[10px] text-gray-400 font-mono">0</span>
                            <div id="desc-seo" class="dot bg-gray-200"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Fecha</label>
                            <input type="date" id="post-date" class="w-full text-sm bg-transparent border-b border-gray-200 py-1 focus:outline-none focus:border-black dark:border-slate-700">
                        </div>
                        <div>
                            <label class="block text-[10px] uppercase font-bold text-gray-400 mb-1 flex justify-between">Autor <span class="cursor-pointer text-blue-500" onclick="openAuthorModal()">+</span></label>
                            <select id="post-author" class="w-full text-sm bg-transparent border-b border-gray-200 py-1 focus:outline-none focus:border-black dark:border-slate-700">
                                <option>Cargando...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Hero Image</label>
                            <div class="flex">
                                <input type="text" id="post-hero" class="flex-1 text-sm bg-transparent border-b border-gray-200 py-1 focus:outline-none focus:border-black dark:border-slate-700" placeholder="URL...">
                                <label class="cursor-pointer ml-2 hover:bg-gray-100 p-1 rounded">
                                    üìÅ <input type="file" class="hidden" accept="image/*" onchange="uploadHeroImage(this)">
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-gray-400 text-sm">#</span>
                            <input type="text" id="tag-input" class="flex-1 text-sm outline-none bg-transparent" placeholder="Etiquetas (Enter para agregar)">
                        </div>
                        <div id="tags-container" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
            </div>

            <div class="sticky top-16 z-30 bg-white/90 dark:bg-slate-900/90 backdrop-blur border border-gray-200 dark:border-slate-700 rounded-xl p-2 mb-8 flex flex-wrap gap-1 shadow-sm justify-center">
                <button onclick="addBlock('h2')" class="px-3 py-1 text-xs font-bold hover:bg-gray-100 rounded">H2</button>
                <button onclick="addBlock('h3')" class="px-3 py-1 text-xs font-bold hover:bg-gray-100 rounded">H3</button>
                <button onclick="addBlock('p')" class="px-3 py-1 text-xs hover:bg-gray-100 rounded flex items-center gap-1">üìÑ Texto</button>
                <button onclick="addBlock('quote')" class="px-3 py-1 text-xs hover:bg-gray-100 rounded">‚ùù Cita</button>
                <div class="w-px h-4 bg-gray-300 mx-1 self-center"></div>
                <button onclick="addBlock('img')" class="px-3 py-1 text-xs hover:bg-gray-100 rounded">üñºÔ∏è Imagen</button>
                <button onclick="addBlock('yt')" class="px-3 py-1 text-xs hover:bg-gray-100 rounded">üé¨ Video</button>
                <button onclick="addBlock('list')" class="px-3 py-1 text-xs hover:bg-gray-100 rounded">üìã Lista</button>
                <button onclick="addBlock('hr')" class="px-3 py-1 text-xs hover:bg-gray-100 rounded">‚ûñ HR</button>
            </div>

            <div id="blocks-container" class="min-h-[200px]">
                <div class="text-center py-10 text-gray-300 italic">No hay bloques. Comienza escribiendo...</div>
            </div>

            <div class="fixed bottom-6 right-6 left-6 md:left-auto md:w-80">
                <button onclick="publishCurrentPost()" class="w-full bg-black dark:bg-white text-white dark:text-black font-bold py-4 rounded-xl shadow-2xl hover:scale-[1.02] transition flex items-center justify-center gap-2">
                    üöÄ Publicar Cambios
                </button>
            </div>

        </main>
    </div>

    <div id="toast-container" class="fixed bottom-6 left-6 z-[80] flex flex-col gap-2"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBdsu65Voj8en9u_7eL5q0YRFuCC7fUYWA",
            authDomain: "instantetrips-editor.firebaseapp.com",
            projectId: "instantetrips-editor",
            storageBucket: "instantetrips-editor.firebasestorage.app",
            messagingSenderId: "281917140804",
            appId: "1:281917140804:web:ed712e65c9c4b77dd3b111"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- ADMIN SECURITY ---
        const MASTER_ADMIN_EMAIL = "daniearanadj@gmail.com";
        const canDelete = () => auth.currentUser && auth.currentUser.email.toLowerCase() === MASTER_ADMIN_EMAIL.toLowerCase();

        // STATE
        let githubConfig = null;
        let blocks = [];
        let tags = [];
        let allPosts = [];
        let currentPostSha = null;
        let currentPostFilename = null;
        let autosaveInterval = null;

        // AUTH
        const loginForm = document.getElementById('login-form');
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = loginForm.querySelector('button');
            btn.innerHTML = '<div class="loader mx-auto"></div>'; btn.disabled = true;
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
            } catch (error) {
                document.getElementById('login-error').classList.remove('hidden');
                document.getElementById('login-error').textContent = "Credenciales incorrectas";
                btn.innerHTML = 'Iniciar Sesi√≥n'; btn.disabled = false;
            }
        });

        document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('app-section').classList.remove('hidden');
                document.getElementById('post-date').valueAsDate = new Date();
                
                const docSnap = await getDoc(doc(db, "config", "main"));
                if (docSnap.exists()) {
                    githubConfig = docSnap.data();
                    if (!githubConfig.postsPath.endsWith('/')) githubConfig.postsPath += '/';
                    loadAuthorsFromRepo();
                    startAutosave();
                    checkDraft();
                } else {
                    alert("Falta configuraci√≥n en Firebase");
                }
            } else {
                document.getElementById('login-section').classList.remove('hidden');
                document.getElementById('app-section').classList.add('hidden');
                stopAutosave();
            }
        });

        // GITHUB API
        async function ghFetch(ep, m='GET', b=null) {
            const res = await fetch(`https://api.github.com/repos/${githubConfig.repoOwner}/${githubConfig.repoName}${ep}`, {
                method: m,
                headers: { 'Authorization': `token ${githubConfig.githubToken}`, 'Content-Type': 'application/json' },
                body: b ? JSON.stringify(b) : null
            });
            if (!res.ok) throw new Error(`GitHub Error: ${res.status}`);
            return res.json();
        }

        // DELETE FUNCTIONS (ADMIN)
        async function deleteFile(path, sha) {
            if (!canDelete()) throw new Error("Acceso denegado");
            await ghFetch(`/contents/${path}`, 'DELETE', { message: `Delete ${path}`, sha, branch: githubConfig.branch });
        }
        
        async function deleteAuthor(slug) {
            if (!canDelete()) throw new Error("Acceso denegado");
            const file = await ghFetch(`/contents/src/data/authors.ts`);
            const content = decodeURIComponent(escape(atob(file.content)));
            const regex = new RegExp(`\\s*'${slug}':\\s*{[^}]*},?`, 'g');
            const newContent = content.replace(regex, '');
            await ghFetch(`/contents/src/data/authors.ts`, 'PUT', { message: `Del auth ${slug}`, content: btoa(unescape(encodeURIComponent(newContent))), sha: file.sha, branch: githubConfig.branch });
        }

        // RENDER UI
        window.openLoadModal = async () => {
             document.getElementById('load-post-modal').classList.add('open');
             if(!allPosts.length) {
                 document.getElementById('posts-list').innerHTML = '<div class="text-center py-4">Cargando...</div>';
                 const files = await ghFetch(`/contents/${githubConfig.postsPath}`);
                 allPosts = files.filter(f => f.name.endsWith('.md')).map(f => ({ name: f.name, sha: f.sha }));
                 renderPostsList(allPosts);
             }
        }

        function renderPostsList(posts) {
            const list = document.getElementById('posts-list');
            const isAdmin = canDelete();
            
            list.innerHTML = posts.map(p => `
                <div class="flex items-center justify-between p-3 border-b border-gray-100 hover:bg-gray-50 dark:hover:bg-slate-800 transition">
                    <span onclick="loadPost('${p.name}')" class="cursor-pointer font-medium text-sm text-gray-700 dark:text-gray-300 hover:text-black">${p.name}</span>
                    <div class="flex items-center gap-2">
                         <button onclick="loadPost('${p.name}')" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded font-bold">Editar</button>
                         ${isAdmin ? `<button onclick="confirmDeletePost('${p.name}', '${p.sha}')" class="text-red-500 hover:bg-red-100 p-1 rounded" title="Borrar"><svg class="w-4 h-4"><use href="#icon-trash"></use></svg></button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function loadAuthorsFromRepo() {
            try {
                const file = await ghFetch(`/contents/src/data/authors.ts`);
                const content = decodeURIComponent(escape(atob(file.content)));
                const regex = /slug:\s*['"]([^'"]+)['"][\s\S]*?name:\s*['"]([^'"]+)['"]/g;
                
                const select = document.getElementById('post-author');
                const adminList = document.getElementById('authors-list-container');
                const isAdmin = canDelete();
                
                select.innerHTML = '<option value="">Selecciona...</option>';
                let htmlList = '';
                let match;
                
                while ((match = regex.exec(content)) !== null) {
                    const [_, slug, name] = match;
                    select.innerHTML += `<option value="${slug}">${name}</option>`;
                    htmlList += `
                        <div class="flex justify-between items-center p-2 border-b text-sm">
                            <span>${name}</span>
                            ${isAdmin ? `<button onclick="confirmDeleteAuthor('${slug}', '${name}')" class="text-red-500 hover:bg-red-100 p-1 rounded"><svg class="w-3 h-3"><use href="#icon-trash"></use></svg></button>` : ''}
                        </div>`;
                }
                adminList.innerHTML = htmlList || '<p class="text-xs text-gray-400">No hay autores.</p>';
            } catch(e) { console.error(e); }
        }

        // ACTIONS
        window.confirmDeletePost = async (n, s) => {
            if(confirm(`‚ö†Ô∏è ADMIN: ¬øBorrar permanentemente "${n}"?`)) {
                try { await deleteFile(`${githubConfig.postsPath}${n}`, s); allPosts = allPosts.filter(x=>x.name!==n); renderPostsList(allPosts); showToast("Archivo borrado"); }
                catch(e) { showToast("Error: " + e.message, "error"); }
            }
        }
        
        window.confirmDeleteAuthor = async (s, n) => {
            if(confirm(`‚ö†Ô∏è ADMIN: ¬øBorrar autor "${n}" del c√≥digo?`)) {
                try { await deleteAuthor(s); loadAuthorsFromRepo(); showToast("Autor borrado"); }
                catch(e) { showToast("Error: " + e.message, "error"); }
            }
        }

        window.loadPost = async (name) => {
             try {
                 const d = await ghFetch(`/contents/${githubConfig.postsPath}${name}`);
                 const c = decodeURIComponent(escape(atob(d.content)));
                 parseMarkdown(c);
                 currentPostFilename = name; currentPostSha = d.sha;
                 closeLoadModal(); showToast("Post cargado");
             } catch(e) { showToast("Error al cargar", "error"); }
        }

        // EDITOR CORE (BLOCKS)
        window.addBlock = (type) => {
             const c = document.getElementById('blocks-container');
             if(c.innerText.includes("No hay bloques")) c.innerHTML = '';
             blocks.push({ id: Date.now().toString(), type, content: '', credits: '', listType: 'ul' });
             renderBlocks();
        }

        window.removeBlock = (id) => {
             if(confirm("¬øEliminar este bloque?")) {
                 blocks = blocks.filter(b => b.id !== id);
                 renderBlocks();
             }
        }

        function renderBlocks() {
            const container = document.getElementById('blocks-container');
            const scroll = container.scrollTop;
            container.innerHTML = '';

            blocks.forEach(b => {
                const el = document.createElement('div');
                el.className = 'block-card group'; // Card Style applied here
                
                // HEADER DE TARJETA (Drag & Delete)
                let header = `
                    <div class="flex justify-between items-center bg-gray-50 dark:bg-slate-800 p-2 rounded-t-lg border-b border-gray-100 dark:border-slate-700">
                        <div class="drag-handle cursor-grab text-gray-400 hover:text-gray-600 px-2">‚ãÆ‚ãÆ <span class="text-[10px] font-bold uppercase ml-2">${b.type}</span></div>
                        <button onclick="removeBlock('${b.id}')" class="text-gray-400 hover:text-red-500 px-2" title="Eliminar"><svg class="w-4 h-4"><use href="#icon-trash"></use></svg></button>
                    </div>
                `;

                // CONTENIDO
                let body = `<div class="p-0">`;
                
                if (b.type === 'p' || b.type === 'quote') {
                    // TOOLBAR VISIBLE RESTAURADA
                    body += `
                        <div class="toolbar-inner">
                            <button class="tool-btn" onclick="execCmd('bold')" title="Negrita"><svg class="w-4 h-4"><use href="#icon-bold"></use></svg></button>
                            <button class="tool-btn" onclick="execCmd('italic')" title="Cursiva"><svg class="w-4 h-4"><use href="#icon-italic"></use></svg></button>
                            <button class="tool-btn" onclick="execCmd('underline')" title="Subrayado"><svg class="w-4 h-4"><use href="#icon-underline"></use></svg></button>
                            <div class="tool-sep"></div>
                            <button class="tool-btn" onclick="execCmd('justifyLeft')" title="Izq"><svg class="w-4 h-4"><use href="#icon-left"></use></svg></button>
                            <button class="tool-btn" onclick="execCmd('justifyCenter')" title="Centro"><svg class="w-4 h-4"><use href="#icon-center"></use></svg></button>
                            <button class="tool-btn" onclick="execCmd('justifyRight')" title="Der"><svg class="w-4 h-4"><use href="#icon-right"></use></svg></button>
                            <div class="tool-sep"></div>
                            <button class="tool-btn" onclick="applyLink()" title="Link"><svg class="w-4 h-4"><use href="#icon-link"></use></svg></button>
                            <button class="tool-btn text-red-300 hover:text-red-500" onclick="execCmd('removeFormat')" title="Limpiar"><svg class="w-4 h-4"><use href="#icon-clean"></use></svg></button>
                        </div>
                        <div contenteditable="true" class="rich-editor ${b.type==='quote'?'italic text-gray-600 border-l-4 border-orange-500 pl-4':''}" placeholder="Escribe aqu√≠..." oninput="updateBlockContent('${b.id}', this.innerHTML)">${b.content}</div>
                    `;
                } else if (b.type === 'img' || b.type === 'yt') {
                    body += `
                        <div class="p-4 space-y-3">
                            <div class="flex gap-2">
                                <input type="text" class="flex-1 text-sm p-2 border rounded bg-gray-50" placeholder="URL del recurso..." value="${b.content}" oninput="updateBlockContent('${b.id}', this.value)">
                                ${b.type==='img' ? `<label class="cursor-pointer bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded text-xs font-bold">Subir<input type="file" class="hidden" onchange="uploadImg('${b.id}', this)"></label>`:''}
                            </div>
                            ${b.type==='img' && b.content ? `<img src="${b.content.split('|')[0]}" class="h-40 rounded object-cover border mx-auto">` : ''}
                            <input type="text" class="w-full text-xs text-center italic text-gray-400 bg-transparent outline-none" placeholder="Cr√©ditos (opcional)" value="${b.credits}" oninput="updateBlockContent('${b.id}', this.value, 'credits')">
                        </div>
                    `;
                } else if (b.type.startsWith('h')) {
                    body += `<div class="p-4"><input type="text" class="w-full font-bold ${b.type==='h2'?'text-2xl':'text-xl'} outline-none placeholder-gray-300" placeholder="T√≠tulo..." value="${b.content}" oninput="updateBlockContent('${b.id}', this.value)"></div>`;
                } else if (b.type === 'list') {
                     body += `
                        <div class="p-4">
                            <select class="text-xs mb-2 bg-gray-50 border rounded p-1" onchange="updateBlockContent('${b.id}', this.value, 'listType'); renderBlocks()">
                                <option value="ul" ${b.listType==='ul'?'selected':''}>Vi√±etas</option><option value="ol" ${b.listType==='ol'?'selected':''}>Numerada</option>
                            </select>
                            <div contenteditable="true" class="rich-editor border rounded bg-gray-50 min-h-[60px]" oninput="updateBlockContent('${b.id}', this.innerHTML)">${b.content}</div>
                        </div>`;
                } else if (b.type === 'hr') {
                    body += `<div class="p-4 flex justify-center"><div class="w-full h-px bg-gray-300"></div></div>`;
                }

                body += `</div>`; // End Body
                el.innerHTML = header + body;
                container.appendChild(el);
            });
            container.scrollTop = scroll;
        }

        // HELPERS
        window.updateBlockContent = (id, v, extra) => {
            const b = blocks.find(x=>x.id===id); if(!b) return;
            if(extra==='credits') b.credits = v; else if(extra==='listType') b.listType = v; else b.content = v;
            updateSEO(); // trigger save
        }
        window.execCmd = (c, v) => document.execCommand(c, false, v);
        window.applyLink = () => { const u = prompt("URL:"); if(u) execCmd('createLink', u); }
        window.clearAll = () => {
             if(confirm("¬øBorrar todo?")) {
                 blocks = []; tags = [];
                 ['post-title','post-desc','post-hero'].forEach(id=>document.getElementById(id).value='');
                 localStorage.removeItem('blog-draft-v5');
                 renderBlocks(); renderTags(); updateSEO();
                 currentPostFilename = null; currentPostSha = null;
             }
        }
        
        // UPLOAD & PARSING
        const toBase64 = file => new Promise(r => { const rd = new FileReader(); rd.readAsDataURL(file); rd.onload = () => r(rd.result); });
        window.uploadImg = async (id, input) => {
             const f = input.files[0]; if(!f) return;
             try {
                 const b64 = await toBase64(await imageCompression(f, { maxSizeMB: 1 }));
                 const name = `${Date.now()}-${f.name.replace(/[^a-z0-9]/gi,'-')}`;
                 await ghFetch(`/contents/public/uploads/${name}`, 'PUT', { message:'Up', content: b64.split(',')[1], branch: githubConfig.branch });
                 updateBlockContent(id, `/uploads/${name} | ${f.name}`); renderBlocks();
             } catch(e) { showToast("Error subida", "error"); }
        }

        function generateMarkdown() {
            // ... (Misma l√≥gica de generaci√≥n robusta de V5) ...
            const t = document.getElementById('post-title').value;
            const d = document.getElementById('post-desc').value;
            const dt = document.getElementById('post-date').value;
            const a = document.getElementById('post-author').value;
            const h = document.getElementById('post-hero').value;
            let md = `---\ntitle: "${t}"\ndescription: "${d}"\npublishDate: "${dt}"\nauthor: "${a}"\nheroImage: "${h}"\nlayout: "../../layouts/BlogPost.astro"\ntags: [${tags.map(x=>`"${x}"`).join(', ')}]\n---\n\n`;
            
            blocks.forEach(b => {
                if(b.type==='h2') md+=`## ${b.content}\n\n`;
                else if(b.type==='h3') md+=`### ${b.content}\n\n`;
                else if(b.type==='p') md+=`${b.content}\n\n`;
                else if(b.type==='quote') md+=`> ${b.content}\n\n`;
                else if(b.type==='hr') md+=`***\n\n`;
                else if(b.type==='list') md+=`<${b.listType}>\n${b.content}\n</${b.listType}>\n\n`;
                else if(b.type==='img') {
                     const [u, alt] = b.content.split('|');
                     if(u) md+=`![${alt||'img'}](${u.trim()})\n${b.credits?`<small class="credit-style"><i>${b.credits}</i></small>`:''}\n\n`;
                }
            });
            return md;
        }

        function parseMarkdown(md) {
            // ... (Misma l√≥gica de parseo robusta) ...
            const fm = md.match(/^---\n([\s\S]+?)\n---/);
            if(fm) {
                const get = k => { const m = fm[1].match(new RegExp(`${k}:\\s*["'](.+?)["']`)); return m?m[1]:''; };
                document.getElementById('post-title').value = get('title');
                document.getElementById('post-desc').value = get('description');
                document.getElementById('post-date').value = get('publishDate');
                document.getElementById('post-author').value = get('author');
                document.getElementById('post-hero').value = get('heroImage');
                const tm = fm[1].match(/tags:\s*\[(.*?)\]/);
                if(tm) tags = tm[1].split(',').map(x=>x.trim().replace(/['"]/g,'')).filter(Boolean);
                renderTags();
            }
            const content = md.replace(/^---[\s\S]+?---\s*/, '').trim();
            blocks = [];
            content.split('\n\n').forEach((chunk, i) => {
                 if(chunk.startsWith('## ')) blocks.push({id:Date.now()+i, type:'h2', content:chunk.slice(3)});
                 else if(chunk.startsWith('### ')) blocks.push({id:Date.now()+i, type:'h3', content:chunk.slice(4)});
                 else if(chunk.startsWith('> ')) blocks.push({id:Date.now()+i, type:'quote', content:chunk.slice(2)});
                 else if(chunk.startsWith('***')) blocks.push({id:Date.now()+i, type:'hr'});
                 else if(chunk.startsWith('![')) {
                     const m = chunk.match(/!\[(.*?)\]\((.*?)\)/);
                     if(m) blocks.push({id:Date.now()+i, type:'img', content:`${m[2]} | ${m[1]}`, credits:''});
                 }
                 else blocks.push({id:Date.now()+i, type:'p', content:chunk});
            });
            renderBlocks();
        }

        // SAVE
        window.publishCurrentPost = async () => {
             const btn = document.querySelector('button[onclick="publishCurrentPost()"]');
             const orig = btn.innerText; btn.innerText = "Publicando..."; btn.disabled = true;
             try {
                 const md = generateMarkdown();
                 let fn = currentPostFilename;
                 if(!fn) {
                     const s = document.getElementById('post-title').value.toLowerCase().replace(/[^a-z0-9]+/g,'-');
                     const d = document.getElementById('post-date').value;
                     if(!s||!d) throw new Error("Faltan datos");
                     fn = `${d}-${s}.md`;
                 }
                 const p = { message: `Update ${fn}`, content: btoa(unescape(encodeURIComponent(md))), branch: githubConfig.branch };
                 if(currentPostSha) p.sha = currentPostSha;
                 const res = await ghFetch(`/contents/${githubConfig.postsPath}${fn}`, 'PUT', p);
                 currentPostSha = res.content.sha; currentPostFilename = fn;
                 localStorage.removeItem('blog-draft-v5');
                 showToast("‚úÖ Publicado");
             } catch(e) { showToast("Error: "+e.message, "error"); }
             btn.innerText = orig; btn.disabled = false;
        }

        // UTILS
        function startAutosave() {
             autosaveInterval = setInterval(() => {
                 if(!blocks.length) return;
                 const d = { 
                     title: document.getElementById('post-title').value,
                     desc: document.getElementById('post-desc').value,
                     date: document.getElementById('post-date').value,
                     hero: document.getElementById('post-hero').value,
                     author: document.getElementById('post-author').value,
                     tags, blocks, filename: currentPostFilename, sha: currentPostSha
                 };
                 localStorage.setItem('blog-draft-v5', JSON.stringify(d));
                 document.getElementById('save-status').innerText = "Guardado auto.";
             }, 10000);
        }
        function checkDraft() {
             const d = localStorage.getItem('blog-draft-v5');
             if(d && confirm("¬øRestaurar borrador?")) {
                 const data = JSON.parse(d);
                 document.getElementById('post-title').value = data.title;
                 document.getElementById('post-desc').value = data.desc;
                 document.getElementById('post-date').value = data.date;
                 document.getElementById('post-hero').value = data.hero;
                 tags = data.tags || []; blocks = data.blocks || [];
                 currentPostFilename = data.filename; currentPostSha = data.sha;
                 renderTags(); renderBlocks();
             }
        }
        window.updateSEO = () => { /* Same SEO logic */ };
        window.uploadHeroImage = async (input) => { /* Same hero upload logic */ };
        window.toggleDarkMode = () => document.body.classList.toggle('dark');
        window.closeLoadModal = () => document.getElementById('load-post-modal').classList.remove('open');
        window.closeAuthorModal = () => document.getElementById('author-modal').classList.remove('open');
        window.addTag = (e) => { if(e.key==='Enter'){ const v=e.target.value.trim(); if(v && !tags.includes(v)){ tags.push(v); e.target.value=''; renderTags(); }}}
        document.getElementById('tag-input').addEventListener('keydown', window.addTag);
        function renderTags() { document.getElementById('tags-container').innerHTML = tags.map(t=>`<span class="bg-gray-200 px-2 rounded text-xs">#${t} <button onclick="tags=tags.filter(x=>x!=='${t}');renderTags()">√ó</button></span>`).join(''); }
        window.showToast = (m,t) => { const d=document.createElement('div'); d.className=`p-3 rounded text-white text-sm font-bold ${t==='error'?'bg-red-500':'bg-black'}`; d.innerText=m; document.getElementById('toast-container').appendChild(d); setTimeout(()=>d.remove(),3000); }
        
        new Sortable(document.getElementById('blocks-container'), { animation: 150, handle: '.drag-handle', onEnd: (evt) => {
             const item = blocks.splice(evt.oldIndex, 1)[0]; blocks.splice(evt.newIndex, 0, item);
        }});
    </script>
</body>
</html>