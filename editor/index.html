<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Instantetrips - Editor</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: '#0f172a', // Slate 900
                        accent: '#f97316',  // Orange 500
                    }
                }
            }
        }
    </script>

    <style>
        /* ESTILO MINIMALISTA "NOTION-LIKE" */
        body { background-color: #fafafa; color: #111; font-family: 'Inter', sans-serif; }
        body.dark { background-color: #000; color: #e5e5e5; }

        /* TARJETAS LIMPIAS */
        .card {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .dark .card { background: #111; border-color: #333; }

        /* INPUTS SUTILES */
        .input-clean {
            background: transparent;
            border: 1px solid #e5e7eb;
            color: #111;
            transition: all 0.2s;
        }
        .input-clean:focus { border-color: #000; outline: none; ring: 0; }
        .dark .input-clean { border-color: #333; color: #fff; }
        .dark .input-clean:focus { border-color: #fff; }

        /* BOTONES */
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; font-size: 0.875rem; transition: all 0.2s; }
        .btn-primary { background: #000; color: #fff; }
        .btn-primary:hover { background: #333; }
        .dark .btn-primary { background: #fff; color: #000; }
        .dark .btn-primary:hover { background: #e5e5e5; }
        
        .btn-ghost { background: transparent; color: #555; }
        .btn-ghost:hover { background: #f3f4f6; color: #000; }
        .dark .btn-ghost { color: #888; }
        .dark .btn-ghost:hover { background: #222; color: #fff; }

        /* EDITOR */
        .rich-editor { min-height: 80px; padding: 0.75rem; outline: none; }
        .rich-editor:empty:before { content: attr(placeholder); color: #9ca3af; pointer-events: none; }
        
        /* SEO DOTS */
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .dot-green { background: #22c55e; }
        .dot-yellow { background: #eab308; }
        .dot-red { background: #ef4444; }

        /* UTILS */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.2); backdrop-filter: blur(2px); z-index: 50; display: none; place-items: center; }
        .modal-overlay.open { display: grid; }
        
        .loader { width: 18px; height: 18px; border: 2px solid #ccc; border-top-color: #000; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .dark .loader { border-color: #555; border-top-color: #fff; }
    </style>
</head>

<body class="antialiased">

    <svg style="display: none;">
        <symbol id="icon-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path></symbol>
        <symbol id="icon-save" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"></path><path d="M17 21v-8H7v8"></path><path d="M7 3v5h8"></path></symbol>
        <symbol id="icon-upload" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></symbol>
        <symbol id="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path></symbol>
        <symbol id="icon-search" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></symbol>
    </svg>

    <div id="load-post-modal" class="modal-overlay">
        <div class="card w-[600px] max-w-[90%] p-6 bg-white dark:bg-black max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b border-gray-100 dark:border-gray-800 pb-3">
                <h3 class="text-sm font-bold uppercase tracking-wide">Publicaciones</h3>
                <button onclick="closeLoadModal()" class="text-xl hover:text-red-500">√ó</button>
            </div>
            <input type="text" id="search-posts" placeholder="Buscar..." class="w-full p-2 rounded input-clean mb-4 text-sm" oninput="filterPosts()">
            <div id="posts-list" class="space-y-1 flex-1 overflow-y-auto">
                </div>
        </div>
    </div>

    <div id="author-modal" class="modal-overlay">
        <div class="card w-[500px] max-w-[90%] p-6 bg-white dark:bg-black max-h-[85vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-sm font-bold uppercase tracking-wide">Gesti√≥n de Autores</h3>
                <button onclick="closeAuthorModal()" class="text-xl">√ó</button>
            </div>
            
            <div class="space-y-3 mb-6">
                <p class="text-xs text-gray-400 font-bold uppercase">Nuevo Autor</p>
                <input type="text" id="new-auth-name" placeholder="Nombre completo" class="w-full p-2 rounded input-clean text-sm">
                <input type="text" id="new-auth-role" placeholder="Rol (ej. Editor)" class="w-full p-2 rounded input-clean text-sm">
                <textarea id="new-auth-bio" rows="2" placeholder="Biograf√≠a..." class="w-full p-2 rounded input-clean text-sm resize-none"></textarea>
                <input type="file" id="new-auth-file" accept="image/*" class="w-full text-xs text-gray-500">
                <button onclick="saveNewAuthor()" id="btn-save-auth" class="w-full btn btn-primary mt-2">Guardar Autor</button>
            </div>

            <div id="authors-list-container" class="border-t border-gray-100 dark:border-gray-800 pt-4">
                </div>
        </div>
    </div>

    <div id="login-section" class="flex items-center justify-center min-h-screen p-4">
        <div class="card p-8 w-full max-w-[380px] text-center">
            <img src="/blog.svg" alt="Logo" class="h-10 mx-auto mb-6">
            <h1 class="text-lg font-bold mb-1">Acceso Editor</h1>
            <p class="text-xs text-gray-500 mb-6">Solo personal autorizado</p>
            <form id="login-form" class="space-y-3">
                <input type="email" id="email" placeholder="Email" class="w-full p-3 rounded input-clean text-sm" required>
                <input type="password" id="password" placeholder="Contrase√±a" class="w-full p-3 rounded input-clean text-sm" required>
                <button type="submit" class="w-full btn btn-primary py-3">Entrar</button>
            </form>
            <p id="login-error" class="text-red-500 text-xs mt-4 hidden"></p>
        </div>
    </div>

    <div id="app-section" class="hidden min-h-screen flex flex-col">
        <header class="h-14 border-b border-gray-200 dark:border-gray-800 bg-white dark:bg-black sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img src="/blog.svg" alt="Blog Logo" class="h-6">
                    <div class="h-4 w-px bg-gray-300 dark:bg-gray-700 mx-1"></div>
                    <span class="text-sm font-semibold tracking-tight">Blog Instantetrips - Publicaciones</span>
                    <span id="save-status" class="ml-2 text-[10px] text-gray-400"></span>
                </div>
                
                <div class="flex items-center gap-1">
                    <button onclick="toggleDarkMode()" class="btn btn-ghost px-2" title="Modo Oscuro">
                        <svg class="w-4 h-4"><use href="#icon-moon"></use></svg>
                    </button>
                    <div class="h-4 w-px bg-gray-300 dark:bg-gray-700 mx-2"></div>
                    <button onclick="openLoadModal()" class="btn btn-ghost text-xs gap-2">Explorar Publicaciones</button>
                    <button onclick="downloadMarkdown()" class="btn btn-ghost text-xs gap-2" title="Descargar local">Backup</button>
                    <button id="btn-logout" class="btn btn-ghost text-xs text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20">Salir</button>
                </div>
            </div>
        </header>

        <main class="flex-1 max-w-5xl mx-auto w-full p-6 grid grid-cols-1 gap-8">
            
            <div class="space-y-4">
                <div class="flex justify-between items-end">
                    <div class="flex-1 mr-4">
                        <input type="text" id="post-title" class="w-full text-3xl font-bold bg-transparent border-none placeholder-gray-300 dark:placeholder-gray-700 focus:ring-0 p-0" placeholder="T√≠tulo de la publicaci√≥n..." oninput="updateSEO(); updatePreview()">
                        <div class="flex items-center gap-2 mt-2">
                            <span id="title-count" class="text-[10px] font-mono text-gray-400">0</span>
                            <div id="title-seo" class="dot bg-gray-200"></div>
                        </div>
                    </div>
                    <div class="flex flex-col items-end gap-2">
                         <button onclick="publishCurrentPost()" class="btn btn-primary">Publicar Cambios</button>
                         <button onclick="clearAll()" class="text-xs text-gray-400 hover:text-red-500">Limpiar editor</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 card bg-gray-50 dark:bg-gray-900 border-none">
                    <div class="md:col-span-3">
                        <textarea id="post-desc" rows="2" class="w-full bg-transparent border-none text-sm focus:ring-0 resize-none placeholder-gray-400" placeholder="Escribe una descripci√≥n corta para Google (SEO)..." oninput="updateSEO(); updatePreview()"></textarea>
                        <div class="flex items-center gap-2 justify-end">
                            <span id="desc-count" class="text-[10px] font-mono text-gray-400">0</span>
                            <div id="desc-seo" class="dot bg-gray-200"></div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-[10px] font-bold uppercase text-gray-400">Fecha</label>
                        <input type="date" id="post-date" class="w-full bg-transparent border-b border-gray-200 dark:border-gray-700 text-sm py-1 focus:outline-none focus:border-black" onchange="updatePreview()">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold uppercase text-gray-400 flex justify-between">
                            Autor <span class="cursor-pointer text-blue-500 hover:underline" onclick="openAuthorModal()">Gestionar</span>
                        </label>
                        <select id="post-author" class="w-full bg-transparent border-b border-gray-200 dark:border-gray-700 text-sm py-1 focus:outline-none focus:border-black" onchange="updatePreview()">
                            <option value="">Cargando...</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold uppercase text-gray-400">Hero Image</label>
                        <div class="flex items-center">
                            <input type="text" id="post-hero" class="flex-1 bg-transparent border-b border-gray-200 dark:border-gray-700 text-sm py-1 focus:outline-none focus:border-black" placeholder="URL...">
                            <label class="cursor-pointer ml-2 text-gray-400 hover:text-black dark:hover:text-white">
                                <svg class="w-4 h-4"><use href="#icon-upload"></use></svg>
                                <input type="file" class="hidden" accept="image/*" onchange="uploadHeroImage(this)">
                            </label>
                        </div>
                    </div>
                    <div class="md:col-span-3">
                        <div class="flex items-center gap-2 border-b border-gray-200 dark:border-gray-700 pb-1">
                            <span class="text-gray-400 text-xs">#</span>
                            <input type="text" id="tag-input" class="flex-1 bg-transparent text-sm focus:outline-none" placeholder="Etiquetas (Enter para agregar)">
                        </div>
                        <div id="tags-container" class="flex flex-wrap gap-2 mt-2"></div>
                    </div>
                </div>
            </div>

            <div>
                <div class="flex items-center gap-1 mb-4 border-b border-gray-200 dark:border-gray-800 pb-2 overflow-x-auto">
                    <span class="text-[10px] uppercase font-bold text-gray-400 mr-2">Bloques:</span>
                    <button onclick="addBlock('h2')" class="btn btn-ghost text-xs py-1">H2</button>
                    <button onclick="addBlock('h3')" class="btn btn-ghost text-xs py-1">H3</button>
                    <button onclick="addBlock('p')" class="btn btn-ghost text-xs py-1">Texto</button>
                    <button onclick="addBlock('quote')" class="btn btn-ghost text-xs py-1">‚ùù Cita</button>
                    <div class="w-px h-3 bg-gray-300 mx-1"></div>
                    <button onclick="addBlock('img')" class="btn btn-ghost text-xs py-1">Imagen</button>
                    <button onclick="addBlock('yt')" class="btn btn-ghost text-xs py-1">Video</button>
                    <button onclick="addBlock('list')" class="btn btn-ghost text-xs py-1">Lista</button>
                    <button onclick="addBlock('hr')" class="btn btn-ghost text-xs py-1">Separador</button>
                </div>

                <div id="blocks-container" class="space-y-6 min-h-[300px] pb-20">
                    <div class="text-center py-20 text-gray-300 text-sm">
                        El contenido comienza aqu√≠...
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="toast-container" class="fixed bottom-6 right-6 z-[70] flex flex-col gap-2"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBdsu65Voj8en9u_7eL5q0YRFuCC7fUYWA",
            authDomain: "instantetrips-editor.firebaseapp.com",
            projectId: "instantetrips-editor",
            storageBucket: "instantetrips-editor.firebasestorage.app",
            messagingSenderId: "281917140804",
            appId: "1:281917140804:web:ed712e65c9c4b77dd3b111"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- üõ°Ô∏è CONFIGURACI√ìN DE SEGURIDAD ---
        const MASTER_ADMIN_EMAIL = "daniearanadj@gmail.com";
        const canDelete = () => auth.currentUser && auth.currentUser.email === MASTER_ADMIN_EMAIL;

        // ESTADO GLOBAL
        let githubConfig = null;
        let blocks = [];
        let tags = [];
        let allPosts = [];
        let currentPostSha = null;
        let currentPostFilename = null;
        let autosaveInterval = null;

        // 1. AUTH & INIT
        const loginForm = document.getElementById('login-form');
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = loginForm.querySelector('button');
            const original = btn.innerText; btn.innerHTML = '<div class="loader mx-auto"></div>'; btn.disabled = true;
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
            } catch (error) {
                document.getElementById('login-error').classList.remove('hidden');
                document.getElementById('login-error').textContent = 'Error: Credenciales inv√°lidas';
                btn.innerHTML = original; btn.disabled = false;
            }
        });

        document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('app-section').classList.remove('hidden');
                document.getElementById('post-date').valueAsDate = new Date();
                
                // Cargar Configuraci√≥n
                const docSnap = await getDoc(doc(db, "config", "main"));
                if (docSnap.exists()) {
                    githubConfig = docSnap.data();
                    if (!githubConfig.postsPath.endsWith('/')) githubConfig.postsPath += '/';
                    loadAuthorsFromRepo(); // Cargar lista inicial
                    startAutosave();
                    checkDraft();
                } else {
                    alert("Error cr√≠tico: Falta config en Firebase");
                }
            } else {
                document.getElementById('login-section').classList.remove('hidden');
                document.getElementById('app-section').classList.add('hidden');
                stopAutosave();
            }
        });

        // 2. CORE: GITHUB API (DATA LAYER)
        async function ghFetch(ep, m='GET', b=null) {
            const response = await fetch(`https://api.github.com/repos/${githubConfig.repoOwner}/${githubConfig.repoName}${ep}`, {
                method: m,
                headers: { 'Authorization': `token ${githubConfig.githubToken}`, 'Content-Type': 'application/json' },
                body: b ? JSON.stringify(b) : null
            });
            if (!response.ok) throw new Error(`GitHub API Error: ${response.status}`);
            return response.json();
        }

        async function deleteFileFromRepo(path, sha) {
            if (!canDelete()) throw new Error("No tienes permisos de administrador.");
            await ghFetch(`/contents/${path}`, 'DELETE', {
                message: `Delete file: ${path} (Admin Action)`,
                sha: sha,
                branch: githubConfig.branch
            });
        }

        // 3. CORE: L√ìGICA DE AUTORES
        async function deleteAuthorFromRepo(slug) {
            if (!canDelete()) throw new Error("Permiso denegado.");
            const file = await ghFetch(`/contents/src/data/authors.ts`);
            const currentContent = decodeURIComponent(escape(atob(file.content)));
            
            // Regex para eliminar el bloque del autor
            const regex = new RegExp(`\\s*'${slug}':\\s*{[^}]*},?`, 'g');
            if (!regex.test(currentContent)) throw new Error("Autor no encontrado.");
            
            const newContent = currentContent.replace(regex, '');
            
            await ghFetch(`/contents/src/data/authors.ts`, 'PUT', {
                message: `Delete author: ${slug}`,
                content: btoa(unescape(encodeURIComponent(newContent))),
                sha: file.sha,
                branch: githubConfig.branch
            });
        }

        // 4. UI: RENDERIZADO (VIEW LAYER)
        window.openLoadModal = async () => {
             document.getElementById('load-post-modal').classList.add('open');
             if(!allPosts.length) {
                 const el = document.getElementById('posts-list');
                 el.innerHTML = '<div class="text-center py-4 text-gray-400">Cargando...</div>';
                 try {
                     const files = await ghFetch(`/contents/${githubConfig.postsPath}`);
                     allPosts = files.filter(f => f.name.endsWith('.md')).map(f => ({ name: f.name, sha: f.sha }));
                     renderPostsList(allPosts);
                 } catch(e) { el.innerHTML = '<div class="text-red-500 text-center">Error cargando posts</div>'; }
             }
        }

        function renderPostsList(posts) {
            const list = document.getElementById('posts-list');
            const isAdmin = canDelete();
            
            list.innerHTML = posts.map(p => `
                <div class="flex items-center justify-between p-2 hover:bg-gray-100 dark:hover:bg-gray-900 rounded group transition">
                    <span onclick="loadPostToEditor('${p.name}')" class="flex-1 cursor-pointer font-medium text-sm truncate">${p.name}</span>
                    <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition">
                         <button onclick="loadPostToEditor('${p.name}')" class="text-xs text-blue-500 font-bold px-2">Editar</button>
                         ${isAdmin ? `<button onclick="confirmDeletePost('${p.name}', '${p.sha}')" class="text-xs text-red-500 hover:bg-red-50 p-1 rounded" title="Borrar permanentemente"><svg class="w-4 h-4"><use href="#icon-trash"></use></svg></button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function loadAuthorsFromRepo() {
            try {
                const file = await ghFetch(`/contents/src/data/authors.ts`);
                const content = decodeURIComponent(escape(atob(file.content)));
                
                // Parseo para Select
                const regexSelect = /slug:\s*['"]([^'"]+)['"][\s\S]*?name:\s*['"]([^'"]+)['"]/g;
                let match;
                const select = document.getElementById('post-author');
                const existingVal = select.value;
                select.innerHTML = '<option value="">Selecciona...</option>';
                
                // Parseo para Lista Admin
                let authorsForList = [];
                
                while ((match = regexSelect.exec(content)) !== null) {
                    const slug = match[1];
                    const name = match[2];
                    
                    // Add to select
                    const option = document.createElement('option');
                    option.value = slug; option.text = name;
                    select.appendChild(option);
                    
                    // Add to list array
                    authorsForList.push({slug, name});
                }
                if(existingVal) select.value = existingVal;

                // Render Admin List
                renderAuthorAdminList(authorsForList);

            } catch(e) { console.error("Error cargando autores", e); }
        }

        function renderAuthorAdminList(authors) {
            const container = document.getElementById('authors-list-container');
            const isAdmin = canDelete();
            
            if(!authors.length) { container.innerHTML = ''; return; }
            
            container.innerHTML = `
                <h4 class="text-xs font-bold uppercase text-gray-400 mb-2">Autores Existentes</h4>
                <div class="space-y-1">
                    ${authors.map(a => `
                        <div class="flex justify-between items-center text-sm p-2 bg-gray-50 dark:bg-gray-900 rounded">
                            <span>${a.name}</span>
                            ${isAdmin ? `<button onclick="confirmDeleteAuthor('${a.slug}', '${a.name}')" class="text-gray-400 hover:text-red-500"><svg class="w-3 h-3"><use href="#icon-trash"></use></svg></button>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // 5. BRIDGES & ACTIONS (INTERACTION LAYER)
        window.confirmDeletePost = async (name, sha) => {
            if(!confirm(`‚ö†Ô∏è ATENCI√ìN ADMIN ‚ö†Ô∏è\n\n¬øEst√°s seguro de eliminar "${name}"?\nEsta acci√≥n es irreversible y borrar√° el archivo de GitHub.`)) return;
            try {
                await deleteFileFromRepo(`${githubConfig.postsPath}${name}`, sha);
                allPosts = allPosts.filter(p => p.name !== name);
                renderPostsList(allPosts);
                showToast("Archivo eliminado correctamente");
            } catch(e) { showToast("Error: " + e.message, "error"); }
        }

        window.confirmDeleteAuthor = async (slug, name) => {
            if(!confirm(`‚ö†Ô∏è ATENCI√ìN ADMIN ‚ö†Ô∏è\n\n¬øEliminar al autor "${name}"?\nEsto modificar√° el c√≥digo fuente.`)) return;
            try {
                await deleteAuthorFromRepo(slug);
                loadAuthorsFromRepo(); // Recargar lista
                showToast("Autor eliminado");
            } catch(e) { showToast("Error: " + e.message, "error"); }
        }

        window.loadPostToEditor = async (name) => {
             document.getElementById('posts-list').innerHTML = '<div class="loader mx-auto"></div>';
             try {
                 const data = await ghFetch(`/contents/${githubConfig.postsPath}${name}`);
                 const content = decodeURIComponent(escape(atob(data.content)));
                 parseMarkdownToEditor(content);
                 currentPostFilename = name;
                 currentPostSha = data.sha;
                 closeLoadModal();
                 showToast("Publicaci√≥n cargada");
             } catch(e) { 
                 showToast("Error al leer archivo", "error"); 
                 renderPostsList(allPosts); // Restaurar lista
             }
        }

        // 6. EDITOR LOGIC (BLOCKS, SEO, ETC)
        window.addBlock = (type) => {
            const c = document.getElementById('blocks-container');
            if(c.innerText.includes("El contenido comienza aqu√≠")) c.innerHTML = '';
            blocks.push({ id: Date.now().toString(), type: type, content: '', credits: '', listType: 'ul' });
            renderBlocks();
        }

        function renderBlocks() {
            const container = document.getElementById('blocks-container');
            const scrollPos = container.scrollTop;
            container.innerHTML = '';

            blocks.forEach((b) => {
                const el = document.createElement('div');
                el.className = 'group relative pl-6 transition-all hover:bg-gray-50 dark:hover:bg-gray-900 rounded p-2';
                
                // Drag Handle & Delete
                let controls = `
                    <div class="absolute left-1 top-3 flex flex-col items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <div class="drag-handle cursor-grab text-gray-300 hover:text-gray-500">‚ãÆ‚ãÆ</div>
                        <button onclick="removeBlock('${b.id}')" class="text-gray-300 hover:text-red-500"><svg class="w-3 h-3"><use href="#icon-trash"></use></svg></button>
                    </div>
                `;

                let html = '';
                if(b.type === 'p' || b.type === 'quote') {
                    html = `<div class="relative ${b.type==='quote'?'pl-4 border-l-2 border-orange-500 italic text-gray-600':''}">
                        <div contenteditable="true" class="rich-editor" placeholder="Escribe..." oninput="updateBlockContent('${b.id}', this.innerHTML)">${b.content}</div>
                    </div>`;
                    // Mini Toolbar for text
                    html += `<div class="hidden group-focus-within:flex gap-1 mt-1 border-t border-gray-100 dark:border-gray-800 pt-1">
                        <button onclick="execCmd('bold')" class="text-[10px] font-bold px-2 py-1 hover:bg-gray-200 rounded">B</button>
                        <button onclick="execCmd('italic')" class="text-[10px] italic px-2 py-1 hover:bg-gray-200 rounded">I</button>
                        <button onclick="applyLink()" class="text-[10px] text-blue-500 px-2 py-1 hover:bg-gray-200 rounded">Link</button>
                    </div>`;
                } else if (b.type === 'h2' || b.type === 'h3') {
                     html = `<input type="text" class="w-full bg-transparent font-bold ${b.type==='h2'?'text-2xl':'text-xl'} placeholder-gray-300 focus:outline-none" placeholder="T√≠tulo..." value="${b.content}" oninput="updateBlockContent('${b.id}', this.value)">`;
                } else if (b.type === 'img') {
                     html = `<div class="bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-800 rounded p-3">
                        <div class="flex gap-2 mb-2">
                            <span class="text-[10px] font-bold uppercase text-gray-400 self-center">IMG</span>
                            <input type="text" class="flex-1 bg-transparent text-xs border-b border-gray-200 focus:border-black focus:outline-none" placeholder="URL de la imagen..." value="${b.content}" oninput="updateBlockContent('${b.id}', this.value)">
                            <label class="cursor-pointer text-gray-500 hover:text-black"><svg class="w-4 h-4"><use href="#icon-upload"></use></svg><input type="file" class="hidden" onchange="uploadImageToRepo('${b.id}', this)"></label>
                        </div>
                        ${b.content ? `<img src="${b.content.split('|')[0].trim()}" class="h-32 object-cover rounded mx-auto">` : ''}
                        <input type="text" class="w-full bg-transparent text-[10px] text-center italic text-gray-400 mt-1 focus:outline-none" placeholder="Cr√©ditos..." value="${b.credits}" oninput="updateBlockContent('${b.id}', this.value, 'credits')">
                     </div>`;
                } else if (b.type === 'hr') {
                     html = `<div class="flex items-center justify-center py-2"><div class="h-px w-full bg-gray-200"></div></div>`;
                } else {
                     // Default fallback
                     html = `<div contenteditable="true" class="rich-editor" oninput="updateBlockContent('${b.id}', this.innerHTML)">${b.content}</div>`;
                }

                el.innerHTML = controls + html;
                container.appendChild(el);
            });
            container.scrollTop = scrollPos;
        }

        // Logic helpers
        window.updateBlockContent = (id, val, extra) => {
            const b = blocks.find(x => x.id === id);
            if(!b) return;
            if(extra === 'credits') b.credits = val;
            else b.content = val;
            updatePreview(); // Trigger save logic implicitly via debounce
        }
        window.removeBlock = (id) => { blocks = blocks.filter(x => x.id !== id); renderBlocks(); }
        window.execCmd = (c, v) => document.execCommand(c, false, v);
        window.applyLink = () => {
            const url = prompt("URL:");
            if(url) execCmd('createLink', url);
        }
        
        // Image Upload Helper
        const toBase64 = file => new Promise(r => { const rd = new FileReader(); rd.readAsDataURL(file); rd.onload = () => r(rd.result); });
        
        window.uploadImageToRepo = async (id, input) => {
            const file = input.files[0]; if(!file) return;
            try {
                const b64 = await toBase64(await imageCompression(file, { maxSizeMB: 1 }));
                const fname = `${Date.now()}-${file.name.replace(/[^a-z0-9]/gi,'-').toLowerCase()}`;
                await ghFetch(`/contents/public/uploads/${fname}`, 'PUT', { message: 'Upload img', content: b64.split(',')[1], branch: githubConfig.branch });
                updateBlockContent(id, `/uploads/${fname} | ${file.name}`);
                renderBlocks();
            } catch(e) { showToast("Error al subir", "error"); }
        }

        // 7. UTILS: SEO, AUTOSAVE, MD GENERATOR
        window.updateSEO = () => {
            const t = document.getElementById('post-title').value.length;
            const d = document.getElementById('post-desc').value.length;
            
            document.getElementById('title-count').innerText = t;
            const tDot = document.getElementById('title-seo');
            tDot.className = `dot ${t >= 50 && t <= 65 ? 'dot-green' : t > 10 ? 'dot-yellow' : 'dot-red'}`;
            
            document.getElementById('desc-count').innerText = d;
            const dDot = document.getElementById('desc-seo');
            dDot.className = `dot ${d >= 145 && d <= 165 ? 'dot-green' : d > 50 ? 'dot-yellow' : 'dot-red'}`;
        }

        function startAutosave() {
            autosaveInterval = setInterval(() => {
                if(!blocks.length && !document.getElementById('post-title').value) return;
                const draft = {
                    title: document.getElementById('post-title').value,
                    desc: document.getElementById('post-desc').value,
                    date: document.getElementById('post-date').value,
                    hero: document.getElementById('post-hero').value,
                    author: document.getElementById('post-author').value,
                    tags, blocks,
                    filename: currentPostFilename, sha: currentPostSha
                };
                localStorage.setItem('blog-draft-v5', JSON.stringify(draft));
                const s = document.getElementById('save-status');
                s.innerText = "Guardado"; setTimeout(()=> s.innerText="", 2000);
            }, 10000);
        }

        function checkDraft() {
            const d = localStorage.getItem('blog-draft-v5');
            if(d && confirm("¬øRestaurar borrador anterior?")) {
                const data = JSON.parse(d);
                document.getElementById('post-title').value = data.title;
                document.getElementById('post-desc').value = data.desc;
                document.getElementById('post-date').value = data.date;
                document.getElementById('post-hero').value = data.hero;
                tags = data.tags || []; blocks = data.blocks || [];
                currentPostFilename = data.filename; currentPostSha = data.sha;
                renderTags(); renderBlocks(); updateSEO();
            }
        }

        function generateMarkdown() {
            const title = document.getElementById('post-title').value;
            const desc = document.getElementById('post-desc').value;
            const date = document.getElementById('post-date').value;
            const author = document.getElementById('post-author').value;
            const hero = document.getElementById('post-hero').value;

            let md = `---\ntitle: "${title}"\ndescription: "${desc}"\npublishDate: "${date}"\nauthor: "${author}"\nheroImage: "${hero}"\nlayout: "../../layouts/BlogPost.astro"\ntags: [${tags.map(t => `"${t}"`).join(', ')}]\n---\n\n`;

            blocks.forEach(b => {
                if (b.type === 'h2') md += `## ${b.content}\n\n`;
                else if (b.type === 'h3') md += `### ${b.content}\n\n`;
                else if (b.type === 'quote') md += `> ${b.content}\n\n`;
                else if (b.type === 'hr') md += `***\n\n`;
                else if (b.type === 'p') md += `${b.content}\n\n`;
                else if (b.type === 'img') {
                    const [url, alt] = b.content.split('|').map(s => s.trim());
                    if (url) {
                        md += `![${alt || 'Img'}](${url})\n`;
                        if(b.credits) md += `<small class="credit-style">Cr√©ditos: <i>${b.credits}</i></small>\n\n`;
                        else md += '\n';
                    }
                }
            });
            return md;
        }

        // Tags Logic
        window.addTag = (e) => { if(e.key === 'Enter') { const v = e.target.value.trim(); if(v && !tags.includes(v)) { tags.push(v); e.target.value=''; renderTags(); } } }
        document.getElementById('tag-input').addEventListener('keydown', window.addTag);
        function renderTags() { 
            document.getElementById('tags-container').innerHTML = tags.map(t => `<span class="bg-gray-200 text-xs px-2 py-1 rounded flex items-center gap-1">#${t} <button onclick="tags=tags.filter(x=>x!=='${t}');renderTags()" class="hover:text-red-500">√ó</button></span>`).join('');
        }

        // Markdown Parsing (Simplified for brevity but functional)
        function parseMarkdownToEditor(md) {
             const fm = md.match(/^---\n([\s\S]+?)\n---/);
             if(fm) {
                 const get = k => { const m = fm[1].match(new RegExp(`${k}:\\s*["'](.+?)["']`)); return m?m[1]:''; };
                 document.getElementById('post-title').value = get('title');
                 document.getElementById('post-desc').value = get('description');
                 document.getElementById('post-date').value = get('publishDate');
                 document.getElementById('post-author').value = get('author');
                 document.getElementById('post-hero').value = get('heroImage');
                 const tm = fm[1].match(/tags:\s*\[(.*?)\]/);
                 if(tm) tags = tm[1].split(',').map(x=>x.trim().replace(/['"]/g,'')).filter(Boolean);
                 renderTags();
             }
             // Content (Basic Split)
             const content = md.replace(/^---[\s\S]+?---\s*/, '').trim();
             blocks = [];
             content.split('\n\n').forEach((chunk, i) => {
                 if(chunk.startsWith('## ')) blocks.push({id:Date.now()+i, type:'h2', content:chunk.slice(3)});
                 else if(chunk.startsWith('### ')) blocks.push({id:Date.now()+i, type:'h3', content:chunk.slice(4)});
                 else if(chunk.startsWith('> ')) blocks.push({id:Date.now()+i, type:'quote', content:chunk.slice(2)});
                 else if(chunk.startsWith('![')) {
                     const m = chunk.match(/!\[(.*?)\]\((.*?)\)/);
                     if(m) blocks.push({id:Date.now()+i, type:'img', content:`${m[2]} | ${m[1]}`, credits:''});
                 }
                 else blocks.push({id:Date.now()+i, type:'p', content:chunk});
             });
             renderBlocks(); updateSEO();
        }

        // Save/Publish
        window.publishCurrentPost = async () => {
             const btn = document.querySelector('button[onclick="publishCurrentPost()"]');
             btn.innerText = "Publicando..."; btn.disabled = true;
             try {
                 const md = generateMarkdown();
                 let filename = currentPostFilename;
                 if(!filename) {
                     const slug = document.getElementById('post-title').value.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                     const date = document.getElementById('post-date').value;
                     if(!slug || !date) throw new Error("Faltan datos");
                     filename = `${date}-${slug}.md`;
                 }
                 const payload = { message: `Update ${filename}`, content: btoa(unescape(encodeURIComponent(md))), branch: githubConfig.branch };
                 if(currentPostSha) payload.sha = currentPostSha;
                 
                 const res = await ghFetch(`/contents/${githubConfig.postsPath}${filename}`, 'PUT', payload);
                 currentPostSha = res.content.sha; currentPostFilename = filename;
                 localStorage.removeItem('blog-draft-v5');
                 showToast("‚úÖ Publicado con √©xito");
             } catch(e) { showToast("Error: " + e.message, "error"); }
             btn.innerText = "Publicar Cambios"; btn.disabled = false;
        }

        // Utils
        window.toggleDarkMode = () => document.body.classList.toggle('dark');
        window.closeLoadModal = () => document.getElementById('load-post-modal').classList.remove('open');
        window.closeAuthorModal = () => document.getElementById('author-modal').classList.remove('open');
        window.showToast = (m,t='success') => {
             const d = document.createElement('div');
             d.className = `p-3 rounded shadow-lg text-sm font-bold text-white mb-2 ${t==='error'?'bg-red-500':'bg-black'}`;
             d.innerText = m;
             document.getElementById('toast-container').appendChild(d);
             setTimeout(()=>d.remove(), 3000);
        }

        // Init Sortable
        new Sortable(document.getElementById('blocks-container'), { animation: 150, handle: '.drag-handle', onEnd: (evt) => {
            const x = blocks.splice(evt.oldIndex, 1)[0]; blocks.splice(evt.newIndex, 0, x);
        }});
        
        console.log("V5 Minimalist Loaded");
    </script>
</body>
</html>