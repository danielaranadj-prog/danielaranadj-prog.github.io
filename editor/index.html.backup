<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publicaciones - Blog.Instantetrips</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script src="https://cdn.tiny.cloud/1/mzaiavt8ne1jnylgt9u8ns2j7xbaofg5gexdmktmbfa09jh3/tinymce/6/tinymce.min.js"
        referrerpolicy="origin"></script>

    <script src="https://unpkg.com/turndown/dist/turndown.js"></script>
    <script src="https://unpkg.com/turndown-plugin-gfm/dist/turndown-plugin-gfm.js"></script>

    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { slate: { 850: '#1e293b' } }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f3f4f6;
            color: #111;
            font-family: 'Inter', sans-serif;
            transition: background 0.3s, color 0.3s;
        }

        body.dark {
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .logo-adaptive {
            filter: invert(1);
            transition: filter 0.3s;
        }

        .dark .logo-adaptive {
            filter: invert(0);
        }

        .dark .tox-tinymce {
            border-color: #334155 !important;
        }

        /* Glassmorphism */
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(255, 255, 255, 0.1);
        }

        .dark .glass-card {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* Animated Gradient Background */
        .gradient-bg {
            background: linear-gradient(-45deg, #f3f4f6, #dbeafe, #fce7f3, #ffedd5, #f3f4f6);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
        }

        .dark .gradient-bg {
            background: linear-gradient(-45deg, #0f172a, #1e1b4b, #1e293b, #0f172a);
            background-size: 400% 400%;
        }

        @keyframes gradientShift {

            0%,
            100% {
                background-position: 0% 50%;
            }

            25% {
                background-position: 50% 100%;
            }

            50% {
                background-position: 100% 50%;
            }

            75% {
                background-position: 50% 0%;
            }
        }

        /* Premium Buttons */
        .btn-primary {
            background: linear-gradient(135deg, #171717 0%, #262626 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .btn-primary:hover::before {
            opacity: 1;
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .dark .btn-primary {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        }

        /* Accent Colors */
        .accent-input {
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .accent-input:focus {
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.15);
            outline: none;
        }

        .text-accent {
            color: #f97316;
        }

        .bg-accent {
            background-color: #f97316;
        }

        /* Modal Animations */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 50;
            display: none;
            place-items: center;
        }

        .modal-overlay.open {
            display: grid;
        }

        .modal-content {
            animation: modalSlideUp 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Enhanced Header */
        .header-enhanced {
            background: linear-gradient(to right, rgba(255, 255, 255, 0.95), rgba(249, 250, 251, 0.95));
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .dark .header-enhanced {
            background: linear-gradient(to right, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.95));
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Interactive Elements */
        .btn-icon {
            transition: all 0.2s ease;
            border-radius: 10px;
        }

        .btn-icon:hover {
            background: rgba(249, 115, 22, 0.1);
            color: #f97316;
            transform: scale(1.05);
        }

        /* Card Hover Effects */
        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px -15px rgba(0, 0, 0, 0.15);
        }

        /* Existing Styles */
        .loader {
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-top-color: #f97316;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            transition: all 0.3s;
        }

        .dot-green {
            background: #22c55e;
            box-shadow: 0 0 8px #22c55e;
        }

        .dot-yellow {
            background: #eab308;
            box-shadow: 0 0 8px #eab308;
        }

        .dot-red {
            background: #ef4444;
            box-shadow: 0 0 8px #ef4444;
        }

        .prose {
            font-size: 0.95rem;
            line-height: 1.7;
            color: #333;
            max-width: 65ch;
            margin: 0 auto;
        }

        .dark .prose {
            color: #e2e8f0;
        }

        .prose h1 {
            font-size: 2.25em;
            font-weight: 800;
            margin-bottom: 0.5em;
            line-height: 1.2;
        }

        .prose h2 {
            font-size: 1.5em;
            font-weight: 700;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }

        .prose p {
            margin-bottom: 1em;
        }

        .prose img {
            border-radius: 8px;
            margin: 1em 0;
            max-width: 100%;
            height: auto;
        }

        .prose iframe {
            width: 100%;
            aspect-ratio: 16/9;
            border-radius: 8px;
            margin: 1em 0;
        }
    </style>
</head>

<body class="antialiased">

    <div id="preview-modal-mobile" class="modal-overlay z-[60]">
        <div class="bg-white dark:bg-slate-900 w-full h-full flex flex-col">
            <div
                class="flex justify-between items-center p-4 border-b dark:border-slate-700 bg-white dark:bg-slate-900">
                <h3 class="font-bold text-lg flex items-center gap-2"><ion-icon name="eye-outline"></ion-icon> Vista
                    Previa</h3>
                <button onclick="closeMobilePreview()" class="text-3xl p-2"><ion-icon
                        name="close-outline"></ion-icon></button>
            </div>
            <div id="mobile-preview-content"
                class="flex-1 overflow-y-auto p-6 prose dark:prose-invert max-w-none pb-20"></div>
        </div>
    </div>

    <div id="load-post-modal" class="modal-overlay">
        <div
            class="modal-content bg-white dark:bg-slate-900 w-full max-w-2xl rounded-2xl shadow-2xl p-6 flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-4 border-b dark:border-slate-800 pb-3">
                <h3 class="font-bold text-lg flex items-center gap-2 text-accent"><ion-icon
                        name="folder-open-outline"></ion-icon> Explorar</h3>
                <button onclick="closeLoadModal()" class="btn-icon p-2"><ion-icon name="close-outline"
                        class="text-2xl"></ion-icon></button>
            </div>
            <input type="text" id="search-posts" placeholder="Buscar..."
                class="w-full p-3 bg-gray-50 dark:bg-slate-800 rounded-xl accent-input border border-gray-200 dark:border-slate-700 mb-4"
                oninput="filterPosts()">
            <div id="posts-list" class="space-y-2 overflow-y-auto flex-1 pr-2"></div>
        </div>
    </div>

    <div id="author-modal" class="modal-overlay">
        <div class="modal-content bg-white dark:bg-slate-900 w-full max-w-lg rounded-2xl shadow-2xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-accent">Autores</h3>
                <button onclick="closeAuthorModal()" class="btn-icon p-2"><ion-icon name="close-outline"
                        class="text-2xl"></ion-icon></button>
            </div>
            <div class="space-y-3">
                <input type="text" id="new-auth-name" placeholder="Nombre"
                    class="w-full p-3 rounded-xl accent-input border border-gray-200 dark:bg-slate-800 dark:border-slate-600">
                <input type="text" id="new-auth-role" placeholder="Rol"
                    class="w-full p-3 rounded-xl accent-input border border-gray-200 dark:bg-slate-800 dark:border-slate-600">
                <textarea id="new-auth-bio" rows="2" placeholder="Bio..."
                    class="w-full p-3 rounded-xl accent-input border border-gray-200 dark:bg-slate-800 dark:border-slate-600"></textarea>
                <input type="file" id="new-auth-file" class="w-full text-xs">
                <button onclick="saveNewAuthor()" id="btn-save-auth"
                    class="w-full btn-primary text-white py-3 rounded-xl font-bold">Guardar</button>
            </div>
            <div id="authors-list-container" class="mt-4 pt-4 border-t dark:border-slate-700"></div>
        </div>
    </div>

    <div id="login-section" class="flex items-center justify-center min-h-screen p-4 gradient-bg">
        <div class="w-full max-w-sm text-center glass-card rounded-3xl p-8">
            <div class="mb-8">
                <img src="public/blog.svg" alt="Logo" class="h-14 mx-auto mb-4 logo-adaptive">
                <h1
                    class="text-2xl font-bold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent">
                    Editor V6.3</h1>
                <p class="text-xs text-gray-400 mt-1">Panel de Publicaciones</p>
            </div>
            <form id="login-form" class="space-y-4">
                <input type="email" id="email" placeholder="Email"
                    class="w-full p-4 bg-white/50 dark:bg-slate-800/50 rounded-xl accent-input border border-gray-200 dark:border-slate-700"
                    required>
                <input type="password" id="password" placeholder="Contrase√±a"
                    class="w-full p-4 bg-white/50 dark:bg-slate-800/50 rounded-xl accent-input border border-gray-200 dark:border-slate-700"
                    required>
                <button type="submit" class="w-full btn-primary text-white font-bold py-4 rounded-xl">Entrar</button>
            </form>
            <p id="login-error" class="text-red-500 text-sm mt-4 hidden"></p>
            <p class="text-xs text-gray-400 mt-6">¬© 2024 Instante Trips</p>
        </div>
    </div>

    <div id="app-section" class="hidden h-[100dvh] flex flex-col">
        <header class="header-enhanced h-16 flex-none z-40">
            <div class="w-full px-4 h-full flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-8 h-8 bg-gradient-to-br from-orange-400 to-orange-600 rounded-lg flex items-center justify-center shadow-lg">
                            <img src="public/blog.svg" alt="Logo" class="h-5 invert">
                        </div>
                        <div>
                            <span class="font-bold text-sm">Editor V6.3</span>
                            <p class="text-[10px] text-gray-500" id="save-status"></p>
                        </div>
                    </div>
                    <!-- Greeting Message (shown after login) -->
                    <div id="greeting-container"
                        class="hidden md:flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-orange-50 to-amber-50 dark:from-orange-900/20 dark:to-amber-900/20 rounded-xl border border-orange-100 dark:border-orange-800/30">
                        <span id="greeting-emoji" class="text-lg"></span>
                        <div>
                            <p id="greeting-text" class="text-xs font-semibold text-gray-700 dark:text-gray-200"></p>
                            <p id="author-role-text" class="text-[10px] text-gray-500"></p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-1">
                    <!-- Admin Button (hidden by default, shown only for admin) -->
                    <a id="admin-link" href="../admin/"
                        class="hidden btn-icon flex items-center gap-2 px-3 py-2.5 text-sm font-medium bg-purple-50 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 rounded-xl"
                        title="Panel de Administraci√≥n">
                        <ion-icon name="settings-outline"></ion-icon>
                        <span class="hidden md:inline">Admin</span>
                    </a>
                    <button onclick="toggleDarkMode()" class="btn-icon p-2.5"><ion-icon name="moon-outline"
                            class="text-lg"></ion-icon></button>
                    <button onclick="openMobilePreview()" class="lg:hidden btn-icon p-2.5 text-accent"><ion-icon
                            name="eye-outline" class="text-lg"></ion-icon></button>
                    <button onclick="openLoadModal()"
                        class="btn-icon flex items-center gap-2 px-4 py-2.5 text-sm font-medium"><ion-icon
                            name="folder-open-outline"></ion-icon> Explorar</button>
                    <button id="btn-logout"
                        class="btn-icon p-2.5 text-red-500 hover:!bg-red-50 hover:!text-red-600"><ion-icon
                            name="log-out-outline" class="text-lg"></ion-icon></button>
                </div>
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden">

            <div class="flex-1 overflow-y-auto p-6 pb-32 border-r border-gray-200 dark:border-slate-800 relative">
                <div class="max-w-3xl mx-auto">
                    <div
                        class="bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-800 rounded-2xl p-6 mb-6 shadow-sm card-hover">
                        <div class="flex justify-between mb-4">
                            <h2 class="text-xs font-bold uppercase text-accent tracking-wider">Configuraci√≥n</h2>
                            <button onclick="clearAll()" class="text-xs text-red-400 hover:underline">Limpiar</button>
                        </div>
                        <div class="space-y-4">
                            <div class="relative">
                                <input type="text" id="post-title"
                                    class="w-full text-2xl font-bold bg-transparent border-b-2 border-gray-200 dark:border-slate-700 py-2 outline-none accent-input"
                                    placeholder="T√≠tulo del Art√≠culo" oninput="updateSEO()">
                                <div class="absolute right-0 top-3 flex items-center gap-2"><span id="title-count"
                                        class="text-xs text-gray-400">0</span>
                                    <div id="title-seo" class="dot bg-gray-200"></div>
                                </div>
                            </div>
                            <textarea id="post-desc" rows="2"
                                class="w-full text-sm bg-gray-50 dark:bg-slate-800 p-3 rounded outline-none resize-none"
                                placeholder="Descripci√≥n SEO..." oninput="updateSEO()"></textarea>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="text-xs font-bold text-gray-400">Fecha</label><input type="date"
                                        id="post-date"
                                        class="w-full bg-transparent border-b py-1 dark:border-slate-700"></div>
                                <div><label class="text-xs font-bold text-gray-400 flex justify-between">Autor <span
                                            onclick="openAuthorModal()"
                                            class="text-blue-500 cursor-pointer">+</span></label><select
                                        id="post-author"
                                        class="w-full bg-transparent border-b py-1 dark:border-slate-700">
                                        <option>Cargando...</option>
                                    </select></div>
                            </div>
                            <div class="flex items-center gap-2"><input type="text" id="post-hero"
                                    class="flex-1 text-sm bg-transparent border-b py-1 dark:border-slate-700"
                                    placeholder="Imagen Principal (URL)" oninput="renderLivePreview()"><label
                                    class="cursor-pointer hover:bg-gray-100 p-2 rounded"><ion-icon
                                        name="cloud-upload-outline"></ion-icon><input type="file" class="hidden"
                                        accept="image/*" onchange="uploadHeroImage(this)"></label></div>
                            <div class="flex items-center gap-2"><span class="text-gray-400 text-sm">#</span><input
                                    type="text" id="tag-input" class="flex-1 text-sm bg-transparent outline-none"
                                    placeholder="Tags (Enter)"></div>
                            <div id="tags-container" class="flex flex-wrap gap-2"></div>

                            <!-- Widget Config -->
                            <div class="pt-4 border-t dark:border-slate-800 mt-4">
                                <label
                                    class="text-xs font-bold uppercase text-accent tracking-widest mb-2 block">Widgets
                                    de Viaje ‚úàÔ∏è Copiar c√≥digo</label>
                                <div class="grid grid-cols-1 gap-2">
                                    <input type="text" id="flight-dest"
                                        class="w-full text-xs bg-gray-50 dark:bg-slate-800 p-2 rounded outline-none border border-transparent focus:border-orange-500 accent-input"
                                        placeholder="Destino Vuelos (Ej: Madrid)">
                                    <input type="text" id="tour-city"
                                        class="w-full text-xs bg-gray-50 dark:bg-slate-800 p-2 rounded outline-none border border-transparent focus:border-orange-500 accent-input"
                                        placeholder="Ciudad Tours (Ej: Madrid)">
                                </div>
                            </div>

                            <!-- Video Button -->
                            <div class="pt-2">
                                <button onclick="insertVideoLink()"
                                    class="flex items-center gap-2 px-3 py-2 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-lg text-sm font-bold hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors w-full justify-center">
                                    <ion-icon name="logo-youtube" class="text-lg"></ion-icon> Insertar Video (YouTube /
                                    TikTok)
                                </button>
                            </div>
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-slate-900 rounded-2xl shadow-lg border border-gray-200 dark:border-slate-800 overflow-hidden min-h-[500px] card-hover">
                        <textarea id="tiny-editor" class="w-full h-full"></textarea>
                    </div>

                    <div class="mt-8 mb-8">
                        <button onclick="publishCurrentPost()"
                            class="w-full btn-primary text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2">
                            <ion-icon name="rocket-outline" class="text-xl"></ion-icon> Publicar Art√≠culo
                        </button>
                    </div>
                </div>
            </div>

            <div class="hidden lg:block w-1/2 bg-white dark:bg-black overflow-y-auto p-12" id="live-preview-column">
                <div class="max-w-2xl mx-auto">
                    <div
                        class="flex items-center gap-2 mb-6 text-xs font-bold uppercase text-gray-400 tracking-widest border-b pb-2">
                        <ion-icon name="eye-outline"></ion-icon> Vista Previa en Vivo
                    </div>
                    <div id="live-preview-content" class="prose dark:prose-invert max-w-none">
                        <h1 class="opacity-50">...</h1>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="toast-container" class="fixed bottom-6 left-6 z-[80] flex flex-col gap-2"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // TURNDOWN
        const turndownService = new TurndownService({ headingStyle: 'atx', codeBlockStyle: 'fenced', bulletListMarker: '-' });
        turndownService.use(turndownPluginGfm.gfm);
        turndownService.addRule('iframe', {
            filter: 'iframe',
            replacement: function (content, node) {
                const src = node.getAttribute('src');
                return src ? '\n\n' + src + '\n\n' : '';
            }
        });
        turndownService.addRule('tiktok', {
            filter: function (node) {
                return node.nodeName === 'BLOCKQUOTE' && node.classList.contains('tiktok-embed');
            },
            replacement: function (content, node) {
                const cite = node.getAttribute('cite');
                return cite ? '\n\n' + cite + '\n\n' : '';
            }
        });
        turndownService.addRule('cta', {
            filter: function (node) {
                return node.nodeName === 'A' && node.classList.contains('cta-destination-card');
            },
            replacement: function (content, node) {
                return '\n\n' + node.outerHTML + '\n\n';
            }
        });

        // FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBdsu65Voj8en9u_7eL5q0YRFuCC7fUYWA",
            authDomain: "instantetrips-editor.firebaseapp.com",
            projectId: "instantetrips-editor",
            storageBucket: "instantetrips-editor.firebasestorage.app",
            messagingSenderId: "281917140804",
            appId: "1:281917140804:web:ed712e65c9c4b77dd3b111"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const MASTER_ADMIN_EMAIL = "danielaranadj@gmail.com";
        const isAdmin = () => auth.currentUser && auth.currentUser.email.toLowerCase() === MASTER_ADMIN_EMAIL.toLowerCase();
        const canDelete = isAdmin;  // Alias for backwards compatibility

        // Email ‚Üí Author mapping (add new authors here)
        const EMAIL_TO_AUTHOR = {
            'danielaranadj@gmail.com': { slug: 'daniel-arana', name: 'Daniel', role: 'Administrador' },
            // Add more authors: 'email@example.com': { slug: 'author-slug', name: 'Display Name', role: 'Role' }
        };

        // Get current author info based on logged-in email
        function getCurrentAuthorInfo() {
            if (!auth.currentUser) return null;
            const email = auth.currentUser.email.toLowerCase();
            return EMAIL_TO_AUTHOR[email] || { slug: null, name: auth.currentUser.email.split('@')[0], role: 'Autor' };
        }

        // Time-based greeting
        function getGreeting() {
            const hour = new Date().getHours();
            if (hour >= 5 && hour < 12) return { text: 'Buenos d√≠as', emoji: '‚òÄÔ∏è' };
            if (hour >= 12 && hour < 19) return { text: 'Buenas tardes', emoji: 'üå§Ô∏è' };
            return { text: 'Buenas noches', emoji: 'üåô' };
        }

        // Show personalized greeting
        function showGreeting() {
            const authorInfo = getCurrentAuthorInfo();
            if (!authorInfo) return;

            const greeting = getGreeting();
            const container = document.getElementById('greeting-container');
            const emojiEl = document.getElementById('greeting-emoji');
            const textEl = document.getElementById('greeting-text');
            const roleEl = document.getElementById('author-role-text');

            emojiEl.textContent = greeting.emoji;
            textEl.textContent = `${greeting.text}, ${authorInfo.name}`;
            roleEl.textContent = authorInfo.role;
            container.classList.remove('hidden');
            container.classList.add('flex');
        }

        let githubConfig = null;
        let tags = [];
        let allPosts = [];
        let currentPostSha = null;
        let currentPostFilename = null;

        // INIT TINYMCE
        function initTinyMCE(initialContent = '') {
            tinymce.init({
                selector: '#tiny-editor',
                height: 600,
                menubar: false,
                skin: window.matchMedia('(prefers-color-scheme: dark)').matches ? 'oxide-dark' : 'oxide',
                content_css: window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'default',
                plugins: 'image media link lists table code preview wordcount help',
                toolbar: 'undo redo | blocks fontsize | bold italic underline | bullist numlist | alignleft aligncenter alignright | link image media | customCtaBtn customVideoBtn | removeformat code',
                content_style: 'body { font-family:Inter,sans-serif; font-size:16px; line-height:1.6 } img { max-width: 100%; height: auto; border-radius: 8px; }',
                convert_urls: false,
                relative_urls: false,
                remove_script_host: false,
                media_live_embeds: true,
                setup: function (editor) {
                    editor.on('init', function () { editor.setContent(initialContent); });
                    editor.on('input change keyup', function () { renderLivePreview(); });

                    editor.ui.registry.addButton('customVideoBtn', {
                        icon: 'embed',
                        tooltip: 'Insertar Video (YouTube/TikTok)',
                        onAction: function (_) {
                            const url = prompt('Pega el enlace del video (YouTube o TikTok):');
                            if (url && url.trim()) {
                                const cleanUrl = url.trim();
                                editor.insertContent(`\n\n${cleanUrl}\n\n`);
                            }
                        }
                    });

                    editor.ui.registry.addButton('customCtaBtn', {
                        icon: 'bookmark',
                        tooltip: 'Insertar CTA Destino',
                        onAction: function (_) {
                            window.insertCtaLink();
                        }
                    });
                },
                images_upload_handler: (blobInfo, progress) => new Promise(async (resolve, reject) => {
                    try {
                        const file = blobInfo.blob();
                        const b64 = await toBase64(await imageCompression(file, { maxSizeMB: 1 }));
                        const name = `${Date.now()}-${file.name.replace(/[^a-z0-9]/gi, '-')}`;
                        await ghFetch(`/contents/public/uploads/${name}`, 'PUT', { message: 'Tiny Upload', content: b64.split(',')[1], branch: githubConfig.branch });
                        resolve(`/uploads/${name}`);
                    } catch (e) { reject('Error subida: ' + e.message); }
                })
            });
        }

        window.insertCtaLink = () => {
            // 1. Pedir datos al usuario
            const url = prompt('URL del Destino (Ej: https://.../ushuaia)', 'https://www.instantetrips.com/argentina/destinos/ushuaia/');
            if (!url) return;

            const emoji = prompt('Emoji / Bandera (Ej: üá¶üá∑)', 'üá¶üá∑');
            const label = prompt('Etiqueta Peque√±a (Ej: Gu√≠a de Destino)', 'Gu√≠a de Destino');
            const title = prompt('T√≠tulo Principal (Ej: Ushuaia: El Fin del Mundo)', 'Ushuaia: El Fin del Mundo');
            const desc = prompt('Descripci√≥n (Ej: Clima, presupuesto...)', 'Clima, presupuesto, tours y experiencias imperdibles ‚Üí');

            // 2. Construir HTML (usando variables CSS para Dark Mode)
            const html = `
            <a href="${url}" target="_blank" class="cta-destination-card" style="display:block; margin:2.5rem 0; padding:1.75rem; background:linear-gradient(135deg, rgba(244,185,66,0.08), rgba(117,170,219,0.08)); border-radius:16px; border-left:4px solid var(--accent-gold, #F4B942); text-decoration:none; color:inherit;">
              <span style="display:inline-flex; align-items:center; gap:8px; margin-bottom:1rem;">
                <span style="font-size:1.5rem;">${emoji}</span>
                <span style="font-size:0.7rem; font-weight:800; text-transform:uppercase; letter-spacing:1.5px; color:var(--brand-blue, #75AADB); background:rgba(117,170,219,0.12); padding:6px 12px; border-radius:20px;">${label}</span>
              </span>
              <br>
              <strong style="font-size:1.4rem; font-weight:800; color:var(--text-main, #2D3748);">${title}</strong>
              <br>
              <span style="color:var(--text-muted, #718096); font-size:0.95rem;">${desc}</span>
            </a>
            <p>&nbsp;</p>
            `;

            // 3. Insertar en TinyMCE
            if (tinymce.activeEditor) {
                tinymce.activeEditor.insertContent(html);
            }
        };

        window.insertVideoLink = () => {
            const input = prompt('Pega el enlace o c√≥digo embed (YouTube/TikTok):');
            if (!input || !input.trim()) return;

            let cleanUrl = input.trim();

            // Basic check for HTML embed code
            if (cleanUrl.includes('<iframe') || cleanUrl.includes('<blockquote')) {
                const div = document.createElement('div');
                div.innerHTML = cleanUrl;

                const iframe = div.querySelector('iframe');
                const blockquote = div.querySelector('blockquote');

                if (iframe && iframe.src) {
                    cleanUrl = iframe.src;
                } else if (blockquote && blockquote.getAttribute('cite')) {
                    cleanUrl = blockquote.getAttribute('cite');
                }
            }

            if (tinymce.activeEditor) {
                tinymce.activeEditor.insertContent(`\n\n${cleanUrl}\n\n`);
            }
        };

        function renderLivePreview() {
            let content = '';
            if (tinymce.activeEditor) content = tinymce.activeEditor.getContent();
            const t = document.getElementById('post-title').value;
            const h = document.getElementById('post-hero').value;
            let finalHtml = '';
            if (h) finalHtml += `<img src="${h}" class="w-full h-64 object-cover rounded-xl mb-6 shadow-sm">`;
            if (t) finalHtml += `<h1 class="text-3xl font-bold mb-4">${t}</h1>`;
            finalHtml += content;
            const deskPreview = document.getElementById('live-preview-content');
            if (deskPreview) deskPreview.innerHTML = finalHtml;
            const mobPreview = document.getElementById('mobile-preview-content');
            if (mobPreview) mobPreview.innerHTML = finalHtml;
        }

        window.openMobilePreview = () => { renderLivePreview(); document.getElementById('preview-modal-mobile').classList.add('open'); }
        window.closeMobilePreview = () => document.getElementById('preview-modal-mobile').classList.remove('open');

        const loginForm = document.getElementById('login-form');
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); }
            catch (error) { document.getElementById('login-error').classList.remove('hidden'); document.getElementById('login-error').textContent = "Login fallido"; }
        });
        document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('app-section').classList.remove('hidden');
                document.getElementById('post-date').valueAsDate = new Date();

                // Show admin button only for master admin
                const adminLink = document.getElementById('admin-link');
                if (isAdmin()) {
                    adminLink.classList.remove('hidden');
                } else {
                    adminLink.classList.add('hidden');
                }

                // Show personalized greeting
                showGreeting();

                const docSnap = await getDoc(doc(db, "config", "main"));
                if (docSnap.exists()) {
                    githubConfig = docSnap.data();
                    if (!githubConfig.postsPath.endsWith('/')) githubConfig.postsPath += '/';
                    loadAuthorsFromRepo();
                    initTinyMCE();
                }
            } else {
                document.getElementById('login-section').classList.remove('hidden');
                document.getElementById('app-section').classList.add('hidden');
                document.getElementById('admin-link').classList.add('hidden');
            }
        });

        async function ghFetch(ep, m = 'GET', b = null) {
            const res = await fetch(`https://api.github.com/repos/${githubConfig.repoOwner}/${githubConfig.repoName}${ep}`, {
                method: m,
                headers: { 'Authorization': `token ${githubConfig.githubToken}`, 'Content-Type': 'application/json' },
                body: b ? JSON.stringify(b) : null
            });
            if (!res.ok) throw new Error(`GitHub: ${res.status}`);
            return res.json();
        }

        const toBase64 = file => new Promise(r => { const rd = new FileReader(); rd.readAsDataURL(file); rd.onload = () => r(rd.result); });

        function validatePost() {
            const title = document.getElementById('post-title').value.trim();
            const desc = document.getElementById('post-desc').value.trim();
            const heroImage = document.getElementById('post-hero').value.trim();
            const content = tinymce.activeEditor ? tinymce.activeEditor.getContent() : '';
            const errors = [];

            if (!title || title.length < 10) {
                errors.push('‚ùå El t√≠tulo debe tener al menos 10 caracteres');
            }

            if (title.length > 70) {
                errors.push('‚ö†Ô∏è El t√≠tulo es muy largo (m√°x 70 caracteres para SEO)');
            }

            if (!desc || desc.length < 50) {
                errors.push('‚ùå La descripci√≥n debe tener al menos 50 caracteres');
            }

            if (desc.length > 160) {
                errors.push('‚ö†Ô∏è La descripci√≥n es muy larga (m√°x 160 para SEO)');
            }

            if (tags.length === 0) {
                errors.push('‚ùå Agrega al menos un tag');
            }

            if (!heroImage) {
                errors.push('‚ùå Agrega una imagen principal');
            }

            if (!content || content.length < 100) {
                errors.push('‚ùå El contenido es muy corto (m√≠nimo 100 caracteres)');
            }

            return errors;
        }

        window.publishCurrentPost = async () => {
            // Validar antes de publicar
            const errors = validatePost();
            if (errors.length > 0) {
                alert(errors.join('\n\n'));
                return;
            }

            const btn = document.querySelector('button[onclick="publishCurrentPost()"]');
            const orig = btn.innerText; btn.innerText = "Publicando..."; btn.disabled = true;
            try {
                const rawContent = tinymce.activeEditor.getContent();
                let mdContent = turndownService.turndown(rawContent);
                const t = document.getElementById('post-title').value;
                const d = document.getElementById('post-desc').value;
                const dt = document.getElementById('post-date').value;
                const a = document.getElementById('post-author').value;
                const h = document.getElementById('post-hero').value;
                const fd = document.getElementById('flight-dest').value;
                const tc = document.getElementById('tour-city').value;

                let frontmatter = `---\ntitle: "${t}"\ndescription: "${d}"\npublishDate: "${dt}"\nauthor: "${a}"\nheroImage: "${h}"\nlayout: "../../layouts/BlogPost.astro"\ntags: [${tags.map(x => `"${x}"`).join(', ')}]`;

                if (fd) frontmatter += `\nflight_destination: "${fd}"`;
                if (tc) frontmatter += `\ntour_city: "${tc}"`;

                frontmatter += `\n---\n\n`;
                const finalFile = frontmatter + mdContent;
                let fn = currentPostFilename;
                if (!fn) { const s = t.toLowerCase().replace(/[^a-z0-9]+/g, '-'); fn = `${dt}-${s}.md`; }
                const payload = { message: `Update ${fn}`, content: btoa(unescape(encodeURIComponent(finalFile))), branch: githubConfig.branch };
                if (currentPostSha) payload.sha = currentPostSha;
                const res = await ghFetch(`/contents/${githubConfig.postsPath}${fn}`, 'PUT', payload);
                currentPostSha = res.content.sha; currentPostFilename = fn;
                showToast("‚úÖ Publicado con √©xito");
            } catch (e) { showToast("Error: " + e.message, "error"); }
            btn.innerText = orig; btn.disabled = false;
        };

        window.openLoadModal = async () => {
            document.getElementById('load-post-modal').classList.add('open');
            const files = await ghFetch(`/contents/${githubConfig.postsPath}`);
            allPosts = files.filter(f => f.name.endsWith('.md')).map(f => ({ name: f.name, sha: f.sha }));
            renderPostsList(allPosts);
        };

        window.loadPost = async (name) => {
            try {
                const d = await ghFetch(`/contents/${githubConfig.postsPath}${name}`);
                const raw = decodeURIComponent(escape(atob(d.content)));
                const fmMatch = raw.match(/^---\n([\s\S]+?)\n---/);
                if (fmMatch) {
                    const get = k => { const m = fmMatch[1].match(new RegExp(`${k}:\\s*["'](.+?)["']`)); return m ? m[1] : ''; };
                    document.getElementById('post-title').value = get('title');
                    document.getElementById('post-desc').value = get('description');
                    document.getElementById('post-date').value = get('publishDate');
                    document.getElementById('post-author').value = get('author');
                    document.getElementById('post-hero').value = get('heroImage');
                    const tm = fmMatch[1].match(/tags:\s*\[(.*?)\]/);
                    if (tm) tags = tm[1].split(',').map(x => x.trim().replace(/['"]/g, '')).filter(Boolean);
                    renderTags();

                    document.getElementById('flight-dest').value = get('flight_destination') || '';
                    document.getElementById('tour-city').value = get('tour_city') || '';
                }
                const bodyMd = raw.replace(/^---[\s\S]+?---\s*/, '');
                const bodyHtml = marked.parse(bodyMd);
                tinymce.activeEditor.setContent(bodyHtml);
                currentPostFilename = name; currentPostSha = d.sha;
                closeLoadModal(); showToast("Post cargado"); renderLivePreview();
            } catch (e) { showToast("Error cargando post", "error"); }
        };

        function renderPostsList(posts) {
            document.getElementById('posts-list').innerHTML = posts.map(p =>
                `<div class="flex justify-between p-3 border-b hover:bg-gray-50 dark:hover:bg-slate-800">
                    <span onclick="loadPost('${p.name}')" class="cursor-pointer">${p.name}</span>
                    ${canDelete() ? `<button onclick="deletePost('${p.name}', '${p.sha}')" class="text-red-500"><ion-icon name="trash-outline"></ion-icon></button>` : ''}
                </div>`
            ).join('');
        }

        async function loadAuthorsFromRepo() {
            try {
                const f = await ghFetch(`/contents/src/data/authors.ts`);
                const c = decodeURIComponent(escape(atob(f.content)));
                const r = /slug:\s*['"]([^'"]+)['"][\s\S]*?name:\s*['"]([^'"]+)['"]/g;
                let m; const sel = document.getElementById('post-author');
                sel.innerHTML = '<option>Selecciona...</option>';
                while ((m = r.exec(c)) !== null) { sel.innerHTML += `<option value="${m[1]}">${m[2]}</option>`; }

                // Auto-select author for non-admin users
                const authorInfo = getCurrentAuthorInfo();
                if (authorInfo && authorInfo.slug) {
                    sel.value = authorInfo.slug;

                    // Disable selector for non-admins (they can only post as themselves)
                    if (!isAdmin()) {
                        sel.disabled = true;
                        sel.classList.add('opacity-60', 'cursor-not-allowed');
                        sel.title = 'Tu autor est√° seleccionado autom√°ticamente';
                    }
                }
            } catch (e) { }
        }

        window.deletePost = async (n, s) => { if (confirm("¬øBorrar?")) { await deleteFile(`${githubConfig.postsPath}${n}`, s); openLoadModal(); } };
        window.uploadHeroImage = async (inp) => {
            const f = inp.files[0];
            const b64 = await toBase64(await imageCompression(f, { maxSizeMB: 1 }));
            const name = `${Date.now()}-hero`;
            await ghFetch(`/contents/public/uploads/${name}`, 'PUT', { message: 'Up', content: b64.split(',')[1], branch: githubConfig.branch });
            document.getElementById('post-hero').value = `/uploads/${name}`;
            renderLivePreview();
        };

        window.addTag = (e) => { if (e.key === 'Enter') { const v = e.target.value.trim(); if (v && !tags.includes(v)) { tags.push(v); e.target.value = ''; renderTags(); } } };
        document.getElementById('tag-input').addEventListener('keydown', window.addTag);
        function renderTags() { document.getElementById('tags-container').innerHTML = tags.map(t => `<span class="bg-gray-200 px-2 rounded text-xs">#${t} <button onclick="tags=tags.filter(x=>x!=='${t}');renderTags()">√ó</button></span>`).join(''); }

        window.toggleDarkMode = () => document.body.classList.toggle('dark');
        window.closeLoadModal = () => document.getElementById('load-post-modal').classList.remove('open');
        window.closeAuthorModal = () => document.getElementById('author-modal').classList.remove('open');
        window.clearAll = () => { if (confirm("¬øLimpiar?")) { tinymce.activeEditor.setContent(''); document.getElementById('post-title').value = ''; tags = []; renderTags(); currentPostFilename = null; document.getElementById('flight-dest').value = ''; document.getElementById('tour-city').value = ''; } };
        window.showToast = (m, t) => { const d = document.createElement('div'); d.className = `p-3 rounded text-white text-sm font-bold ${t === 'error' ? 'bg-red-500' : 'bg-black'}`; d.innerText = m; document.getElementById('toast-container').appendChild(d); setTimeout(() => d.remove(), 3000); };
        window.updateSEO = () => {
            const t = document.getElementById('post-title').value.length;
            document.getElementById('title-seo').className = `dot ${t >= 50 && t <= 65 ? 'dot-green' : t > 10 ? 'dot-yellow' : 'dot-red'}`;
            document.getElementById('title-count').innerText = t;
            renderLivePreview();
        };
        // API DELETE
        async function deleteFile(path, sha) {
            if (!canDelete()) throw new Error("Acceso denegado");
            await ghFetch(`/contents/${path}`, 'DELETE', { message: `Delete ${path}`, sha, branch: githubConfig.branch });
        }
    </script>
</body>

</html>